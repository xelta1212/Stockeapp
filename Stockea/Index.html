<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stockea | Sistema de Gesti√≥n</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#2d3748', 850: '#1a202c', 950: '#0f172a' },
                        emerald: { 450: '#10b981' }
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs (v10 Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            doc,
            getDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            orderBy,
            where,
            getDocs,
            limit,
            increment,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile,
            sendEmailVerification,
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            doc,
            getDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            orderBy,
            where,
            getDocs,
            limit,
            increment,
            serverTimestamp
        };
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Critical for Mobile Scroll */
        html,
        body,
        #root {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Smooth Scrolling Container */
        .scroll-view {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%;
            overscroll-behavior-y: contain;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .slide-in {
            animation: slideIn 0.2s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Animaciones para modales */
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-bounce-once {
            animation: bounceOnce 0.6s ease-out;
        }

        @keyframes bounceOnce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
        }
    </style>
    <script>
        // Configuraci√≥n de Firebase (Correcci√≥n: debe ir dentro de <script>)
        const firebaseConfigData = {
            apiKey: "AIzaSyDPr4SZkDNYxGzOtC90k7OoW9pyxel9mPM",
            authDomain: "stockea-bccad.firebaseapp.com",
            projectId: "stockea-bccad",
            storageBucket: "stockea-bccad.firebasestorage.app",
            messagingSenderId: "5932980938",
            appId: "1:5932980938:web:8c90f5f1ef0df5754df233",
            measurementId: "G-GQP09N7HHV"
        };

        // Esta l√≠nea es OBLIGATORIA para que React pueda leer la configuraci√≥n
        window.__firebase_config = JSON.stringify(firebaseConfigData);
    </script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">

        const { useState, useEffect, useMemo, useContext, createContext, useRef } = React;

        const createLucideComponent = (iconName) => {
            return ({ color = "currentColor", size = 24, strokeWidth = 2, className, ...props }) => {
                const iconDef = window.lucide?.icons?.[iconName];
                if (!iconDef) return <span className={className}></span>;
                return React.createElement('svg', {
                    xmlns: "http://www.w3.org/2000/svg",
                    width: size,
                    height: size,
                    viewBox: "0 0 24 24",
                    fill: "none",
                    stroke: color,
                    strokeWidth: strokeWidth,
                    strokeLinecap: "round",
                    strokeLinejoin: "round",
                    className: className,
                    ...props
                }, ...iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index })));
            };
        };

        const iconList = [
            'LayoutDashboard', 'ShoppingCart', 'Users', 'Package', 'Settings', 'LogOut',
            'Menu', 'X', 'Trash2', 'Plus', 'Minus', 'Search', 'FileText', 'Smartphone',
            'CreditCard', 'DollarSign', 'Image', 'QrCode', 'Truck', 'Home', 'Utensils',
            'ChevronRight', 'ClipboardList', 'UserCheck', 'Ban', 'Camera', 'Download', 'RefreshCw',
            'AlertCircle', 'School', 'GraduationCap', 'History', 'Filter', 'Calendar', 'KeyRound', 'Shield', 'Wallet', 'ShoppingBag', 'ArrowDown', 'ArrowUp', 'Clock', 'ChevronDown', 'TrendingUp', 'TrendingDown', 'MessageSquare', 'Send', 'Moon', 'Sun', 'MoreVertical', 'Bell', 'AlertTriangle', 'CheckCircle2', 'MapPin', 'Globe', 'Folder', 'FolderOpen', 'ChevronLeft', 'Edit3', 'XCircle', 'CheckSquare', 'Check', 'BarChart3', 'Save'
        ];

        const Icons = {};
        iconList.forEach(name => Icons[name] = createLucideComponent(name));
        const {
            LayoutDashboard, ShoppingCart, Users, Package, Settings, LogOut,
            Menu, X, Trash2, Plus, Minus, Search, FileText, Smartphone,
            CreditCard, DollarSign, Image: ImageIcon, QrCode, Truck, Home, Utensils,
            ChevronRight, ClipboardList, UserCheck, Ban, Camera, Download, RefreshCw,
            AlertCircle, School, GraduationCap, History, Filter, Calendar, KeyRound, Shield, Wallet, ShoppingBag, ArrowDown, ArrowUp, Clock, ChevronDown, TrendingUp, TrendingDown,
            MessageSquare, Send, Moon, Sun, MoreVertical, Bell, AlertTriangle, CheckCircle2, MapPin, Globe, Folder, FolderOpen, ChevronLeft, Edit3, XCircle, CheckSquare, Check, BarChart3, Save
        } = Icons;

        const ROLES = { ADMIN: 'admin', SELLER: 'vendedor', CASHIER: 'cajero', WAITER: 'mesero' };

        const DEFAULT_CONFIG = {
            storeName: 'Stockea',
            currency: 'S/',
            address: 'Av. Siempre Viva 123',
            phone: '999 000 000',
            email: 'contacto@stockea.com',
            logo: null,
            qrImage: null,
            darkMode: false,
            locations: [{ id: 'main', name: 'Sede Central', mode: 'normal' }]
        };

        const CATEGORY_COLORS = {
            'Bebidas': 'border-blue-500 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
            'Comidas': 'border-orange-500 bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
            'Postres': 'border-pink-500 bg-pink-50 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
            'General': 'border-gray-500 bg-gray-50 text-gray-700 dark:bg-gray-800 dark:text-gray-300',
            'Licores': 'border-purple-500 bg-purple-50 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
            '√ötiles': 'border-yellow-500 bg-yellow-50 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
            'Snacks': 'border-red-500 bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300',
            'default': 'border-emerald-500 bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300'
        };

        const PERMISSIONS_LIST = [
            { id: 'pos', label: 'Punto de Venta' },
            { id: 'orders', label: 'Pedidos / Delivery' },
            { id: 'customers', label: 'Clientes / Comunidad' },
            { id: 'verification', label: 'Verif. Transacciones Digitales' }, // NUEVO MODULO
            { id: 'inventory', label: 'Inventario' },
            { id: 'qrs', label: 'Gesti√≥n de QRs' },
            { id: 'reports', label: 'Reportes' },
            { id: 'alerts', label: 'Alertas de Cobranza' },
            { id: 'settings', label: 'Configuraci√≥n' },
            { id: 'users', label: 'Equipo' },
            { id: 'waiter', label: 'Sistema de Men√∫s' },
            { id: 'chat', label: 'Chat de Equipo' },
            { id: 'kitchen', label: 'Pantalla Cocina (KDS)' }
        ];

        const formatMoney = (amount, currency = 'S/') => `${currency} ${parseFloat(amount || 0).toFixed(2)}`;

        const getCurrentDateTimeLocal = () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        };

        const compressImage = (file, maxWidth = 400) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        const PDFService = {
            generateReceipt: (order, config) => {

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ width: 80, height: 200 });
                let y = 10;
                if (config.logo) { try { doc.addImage(config.logo, 'JPEG', 25, y, 30, 30); y += 35; } catch (e) { } }
                doc.setFontSize(12); doc.text(config.storeName, 40, y, { align: 'center' }); y += 5;
                doc.setFontSize(8); doc.text(config.address, 40, y, { align: 'center' }); y += 10;
                doc.text(`Cliente: ${order.customerName}`, 5, y); y += 5;
                doc.text(`Fecha: ${new Date(order.date).toLocaleString()}`, 5, y); y += 8;
                order.items.forEach(item => {
                    doc.text(`${item.quantity}x ${item.name}`, 5, y);
                    doc.text(`${formatMoney(item.price * item.quantity, config.currency)}`, 75, y, { align: 'right' });
                    y += 5;
                });
                y += 5;
                doc.setFontSize(12); doc.text(`TOTAL: ${formatMoney(order.total, config.currency)}`, 75, y, { align: 'right' });
                if (order.method === 'Credit') { y += 5; doc.setFontSize(9); doc.text('(VENTA A CR√âDITO)', 40, y, { align: 'center' }); }
                if (order.comment) { y += 5; doc.setFontSize(8); doc.text(`Nota: ${order.comment}`, 5, y + 5); }
                doc.save(`Recibo_${order.id.slice(0, 4)}.pdf`);
            },
            generateMenuTicket: (items, total, config) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ width: 80, height: 297 }); // Altura A4 para evitar cortes
                let y = 10;

                // Encabezado
                if (config.logo) { try { doc.addImage(config.logo, 'JPEG', 25, y, 30, 30); y += 35; } catch (e) { } }
                doc.setFontSize(12); doc.text("PEDIDO DE MEN√ö", 40, y, { align: 'center' }); y += 6;
                doc.setFontSize(9); doc.text(config.storeName, 40, y, { align: 'center' }); y += 6;
                doc.setFontSize(8); doc.text(`Fecha: ${new Date().toLocaleString()}`, 40, y, { align: 'center' }); y += 10;

                // Preparar datos para la tabla
                const tableBody = items.map(item => {
                    const desc = item.name + (item.obs ? `\n(${item.obs})` : '');
                    return [desc, formatMoney(item.price, config.currency)];
                });

                // Generar tabla
                doc.autoTable({
                    head: [['Descripci√≥n', 'Precio']],
                    body: tableBody,
                    startY: y,
                    theme: 'plain', // Dise√±o simple tipo ticket
                    styles: { fontSize: 9, cellPadding: 1, overflow: 'linebreak' },
                    columnStyles: { 0: { cellWidth: 45 }, 1: { cellWidth: 20, halign: 'right' } },
                    margin: { left: 5, right: 5 }
                });

                // Total
                y = doc.lastAutoTable.finalY + 5;
                doc.setFontSize(12); doc.setFont(undefined, 'bold');
                doc.text(`TOTAL: ${formatMoney(total, config.currency)}`, 70, y, { align: 'right' });

                // Pie de p√°gina
                y += 10;
                doc.setFontSize(8); doc.setFont(undefined, 'normal');
                doc.text("¬°Gracias por su preferencia!", 40, y, { align: 'center' });

                doc.autoPrint();
                window.open(doc.output('bloburl'), '_blank');
            }, generateCustomerStatement: (customer, movements, filterName, config) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 15;
                if (config.logo) { try { doc.addImage(config.logo, 'JPEG', 170, 10, 25, 25); } catch (e) { } }
                doc.setFontSize(18); doc.text(`Estado de Cuenta: ${customer.name}`, 14, 20);
                doc.setFontSize(10); doc.text(`Periodo: ${filterName}`, 14, 28);
                if (customer.grade) doc.text(`Grado/Secci√≥n: ${customer.level || ''} ${customer.grade} ${customer.section || ''}`, 14, 34);

                const rows = movements.map(m => {
                    let desc = '';
                    let tipo = '';
                    if (m.status === 'Anulado') {
                        desc = 'ANULADO'; tipo = 'Anulado';
                    } else if (m.method === 'Abono') {
                        desc = 'ABONO A CUENTA'; tipo = 'Pago';
                    } else if (m.method === 'Cargo Manual') {
                        desc = 'CARGO MANUAL / AJUSTE'; tipo = 'Cargo';
                    } else {
                        desc = m.items.map(i => `${i.quantity}x ${i.name}`).join(', '); tipo = 'Venta';
                    }
                    if (m.comment) desc += ` (${m.comment})`;
                    return [new Date(m.date).toLocaleDateString() + ' ' + new Date(m.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), desc, tipo, m.status === 'Anulado' ? '0.00' : formatMoney(m.total, config.currency)];
                });

                doc.autoTable({ head: [["Fecha", "Detalle", "Tipo", "Monto"]], body: rows, startY: 40 });
                const finalY = doc.lastAutoTable.finalY || 50;

                doc.setFontSize(12);
                if (customer.credit < 0) { doc.setTextColor(0, 128, 0); doc.text(`Saldo a Favor del Cliente: ${formatMoney(Math.abs(customer.credit), config.currency)}`, 14, finalY + 10); }
                else { doc.setTextColor(200, 0, 0); doc.text(`Deuda Total Pendiente: ${formatMoney(customer.credit, config.currency)}`, 14, finalY + 10); }
                doc.save(`EstadoCuenta_${customer.name}.pdf`);
            },
            generateClassroomReport: (data, title, config) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                if (config.logo) { try { doc.addImage(config.logo, 'JPEG', 170, 10, 25, 25); } catch (e) { } }
                doc.setFontSize(18); doc.text(title, 14, 20);
                doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString()}`, 14, 28);
                let grandTotal = 0;
                const rows = data.map((c, i) => {
                    grandTotal += c.credit;
                    return [i + 1, c.name, c.type === 'Alumno' ? `${c.level?.charAt(0)} ${c.grade} "${c.section}"` : c.type, c.guardian || '-', formatMoney(c.credit, config.currency)];
                });
                doc.autoTable({ head: [["#", "Nombre", "Sal√≥n / Tipo", "Apoderado", "Deuda (Saldo)"]], body: rows, startY: 35, theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [16, 185, 129] } });
                doc.setFontSize(14); doc.text(`DEUDA TOTAL DEL SAL√ìN/GRUPO: ${formatMoney(grandTotal, config.currency)}`, 14, doc.lastAutoTable.finalY + 15);
                doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
            },
            generateReport: (orders, type, config) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                if (config.logo) { try { doc.addImage(config.logo, 'JPEG', 170, 10, 25, 25); } catch (e) { } }
                doc.text(`Reporte de Ventas - ${type}`, 14, 20);
                let total = 0;
                const rows = orders.map(o => { total += o.total; return [new Date(o.date).toLocaleDateString(), o.customerName, o.method, formatMoney(o.total, config.currency)]; });
                doc.autoTable({ head: [["Fecha", "Cliente", "M√©todo", "Total"]], body: rows, startY: 30 });
                doc.text(`TOTAL: ${formatMoney(total, config.currency)}`, 14, doc.lastAutoTable.finalY + 10);
                doc.save(`Reporte_${type}.pdf`);
            }
        };

        // ===== FORMULARIO DE CONTACTO =====
        const ContactoModal = ({ mostrar, cerrar }) => {
            const [datos, setDatos] = React.useState({
                nombre: '', negocio: '', email: '', telefono: '', mensaje: ''
            });
            const [enviando, setEnviando] = React.useState(false);
            const [error, setError] = React.useState('');
            const [exito, setExito] = React.useState(false);

            const enviarSolicitud = async (e) => {
                e.preventDefault();
                setError('');
                setExito(false);

                if (!datos.nombre || !datos.negocio || !datos.email || !datos.telefono) {
                    setError('Por favor completa todos los campos obligatorios');
                    return;
                }

                setEnviando(true);

                try {
                    // Crear el cuerpo del email
                    const asunto = `Nueva Solicitud Stockea - ${datos.negocio}`;
                    const cuerpo = `
NUEVA SOLICITUD DE STOCKEA ERP
================================

DATOS DEL SOLICITANTE:
- Nombre: ${datos.nombre}
- Negocio: ${datos.negocio}
- Email: ${datos.email}
- Tel√©fono: ${datos.telefono}

MENSAJE:
${datos.mensaje || 'Sin mensaje adicional'}

================================
Fecha: ${new Date().toLocaleString('es-PE')}
                    `.trim();

                    // Crear enlace mailto
                    const mailtoLink = `mailto:stockea.soporte@gmail.com?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
                    const numTelefono = datos.telefono.replace(/\D/g, '');
                    const enlaceWhatsapp = `https://wa.me/51938988074?text=${encodeURIComponent(cuerpo)}`;

                    // Abrir cliente de email
                    window.location.href = mailtoLink;

                    // Abrir WhatsApp en una nueva pesta√±a despu√©s de un peque√±o delay
                    setTimeout(() => {
                        window.open(enlaceWhatsapp, '_blank');
                    }, 1000);

                    // Mostrar mensaje de √©xito
                    setExito(true);

                    // Limpiar formulario despu√©s de 2 segundos
                    setTimeout(() => {
                        setDatos({ nombre: '', negocio: '', email: '', telefono: '', mensaje: '' });
                        setExito(false);
                        cerrar();
                    }, 3000);

                } catch (err) {
                    console.error('Error:', err);
                    setError('Error al abrir el cliente de email. Por favor contacta directamente a stockea.soporte@gmail.com');
                } finally {
                    setEnviando(false);
                }
            };

            if (!mostrar) return null;

            return React.createElement('div', {
                className: 'fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4',
                onClick: cerrar
            }, React.createElement('div', {
                className: 'bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto',
                onClick: e => e.stopPropagation()
            },
                React.createElement('div', { className: 'text-center mb-4' },
                    React.createElement('div', { className: 'text-4xl mb-2' }, 'üìä'),
                    React.createElement('h2', { className: 'text-2xl font-bold text-gray-800 dark:text-white' }, 'Solicitar Stockea ERP'),
                    React.createElement('p', { className: 'text-sm text-gray-600 dark:text-gray-400 mt-2' },
                        'Completa el formulario y nos pondremos en contacto contigo para configurar tu sistema')
                ),

                exito && React.createElement('div', {
                    className: 'mb-4 p-4 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 rounded text-green-700 dark:text-green-400'
                },
                    React.createElement('div', { className: 'flex items-center gap-2' },
                        React.createElement('span', { className: 'text-2xl' }, '‚úÖ'),
                        React.createElement('div', {},
                            React.createElement('p', { className: 'font-bold' }, '¬°Solicitud enviada!'),
                            React.createElement('p', { className: 'text-sm' }, 'Nos contactaremos contigo pronto.')
                        )
                    )
                ),

                error && React.createElement('div', {
                    className: 'mb-3 p-3 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 text-sm'
                }, error),

                React.createElement('form', { onSubmit: enviarSolicitud, className: 'space-y-3' },
                    React.createElement('div', {},
                        React.createElement('label', { className: 'block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1' }, 'Nombre Completo *'),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Juan P√©rez',
                            required: true,
                            disabled: enviando,
                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent',
                            value: datos.nombre,
                            onChange: e => setDatos({ ...datos, nombre: e.target.value })
                        })
                    ),

                    React.createElement('div', {},
                        React.createElement('label', { className: 'block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1' }, 'Nombre del Negocio *'),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Mi Restaurante',
                            required: true,
                            disabled: enviando,
                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent',
                            value: datos.negocio,
                            onChange: e => setDatos({ ...datos, negocio: e.target.value })
                        })
                    ),

                    React.createElement('div', {},
                        React.createElement('label', { className: 'block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1' }, 'Email de Contacto *'),
                        React.createElement('input', {
                            type: 'email',
                            placeholder: 'tu@email.com',
                            required: true,
                            disabled: enviando,
                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent',
                            value: datos.email,
                            onChange: e => setDatos({ ...datos, email: e.target.value })
                        })
                    ),

                    React.createElement('div', {},
                        React.createElement('label', { className: 'block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1' }, 'Tel√©fono / WhatsApp *'),
                        React.createElement('input', {
                            type: 'tel',
                            placeholder: '+51 999 999 999',
                            required: true,
                            disabled: enviando,
                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent',
                            value: datos.telefono,
                            onChange: e => setDatos({ ...datos, telefono: e.target.value })
                        })
                    ),

                    React.createElement('div', {},
                        React.createElement('label', { className: 'block text-xs font-bold text-gray-700 dark:text-gray-300 mb-1' }, 'Mensaje (Opcional)'),
                        React.createElement('textarea', {
                            placeholder: 'Cu√©ntanos sobre tu negocio y necesidades...',
                            disabled: enviando,
                            rows: 3,
                            className: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent resize-none',
                            value: datos.mensaje,
                            onChange: e => setDatos({ ...datos, mensaje: e.target.value })
                        })
                    ),

                    React.createElement('div', { className: 'bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800' },
                        React.createElement('p', { className: 'text-xs text-blue-800 dark:text-blue-300' },
                            'üìß Tu solicitud ser√° enviada a ',
                            React.createElement('strong', {}, 'stockea.soporte@gmail.com'),
                            '. Te contactaremos en menos de 24 horas.'
                        )
                    ),

                    React.createElement('div', { className: 'flex gap-2 pt-2' },
                        React.createElement('button', {
                            type: 'button',
                            onClick: cerrar,
                            disabled: enviando,
                            className: 'flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition'
                        }, 'Cancelar'),
                        React.createElement('button', {
                            type: 'submit',
                            disabled: enviando,
                            className: 'flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2'
                        }, enviando ?
                            React.createElement(React.Fragment, {},
                                React.createElement('div', { className: 'w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin' }),
                                'Enviando...'
                            ) : 'üì® Enviar Solicitud'
                        )
                    )
                ),

                React.createElement('div', { className: 'mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 text-center' },
                    React.createElement('p', { className: 'text-xs text-gray-500 dark:text-gray-400' },
                        '¬øPreguntas? Escr√≠benos a ',
                        React.createElement('a', {
                            href: 'mailto:stockea.soporte@gmail.com',
                            className: 'text-emerald-600 dark:text-emerald-400 font-semibold hover:underline'
                        }, 'stockea.soporte@gmail.com')
                    )
                )
            ));
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [orders, setOrders] = useState([]);
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [loading, setLoading] = useState(true);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [currentView, setCurrentView] = useState('home');
            const [qrs, setQrs] = useState([]);
            const [messages, setMessages] = useState([]);
            const [currentLocation, setCurrentLocation] = useState('all');
            const [loginUser, setLoginUser] = useState('');
            const [loginPin, setLoginPin] = useState('');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [notificationCount, setNotificationCount] = useState(0);
            const [isNotificationOpen, setIsNotificationOpen] = useState(false);
            const [isLoadingAction, setIsLoadingAction] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [filterDateRange, setFilterDateRange] = useState({ from: '', to: '' });
            const [filterCustomer, setFilterCustomer] = useState(null);
            const [loginError, setLoginError] = useState('');
            const [refreshKey, setRefreshKey] = useState(0); // Para forzar recarga de componentes
            const [alertSoundEnabled, setAlertSoundEnabled] = useState(true);
            const [customAlerts, setCustomAlerts] = useState([]);
            const [mostrarContacto, setMostrarContacto] = useState(false); // Modal de contacto
            const [team, setTeam] = useState([]); // Equipo del negocio
            const db = useRef(null);
            const expensesDb = useRef(null);
            const auth = useRef(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'stockea-app-final-v21';
            const [tenantId, setTenantId] = useState(null); // ID √∫nico por cliente

            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, signInWithCustomToken } = window.firebaseModules;
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth.current = getAuth(app);
                    db.current = getFirestore(app);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth.current, __initial_auth_token);
                    else await signInAnonymously(auth.current);
                    onAuthStateChanged(auth.current, (u) => {
                        if (u) {
                            // Para usuarios an√≥nimos, usar appId como tenant por defecto
                            if (!tenantId) setTenantId(appId);
                        }
                    });
                };
                initFirebase();
            }, []);

            // Escuchar cambios de tenant y configurar listeners
            useEffect(() => {
                if (tenantId && db.current) {
                    setupListeners(tenantId);
                }
            }, [tenantId]);

            const setupListeners = (currentTenantId) => {
                const { collection, onSnapshot, query, orderBy, limit } = window.firebaseModules;

                // Usar ruta multi-tenant: /tenants/{tenantId}/...
                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'config'), (snap) => {
                    if (!snap.empty) {
                        const doc = snap.docs[0];
                        const data = doc.data();
                        const mergedConfig = { ...DEFAULT_CONFIG, ...data, locations: data.locations || DEFAULT_CONFIG.locations };
                        setConfig(prev => ({ ...prev, ...mergedConfig, id: doc.id }));
                    }
                });

                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'products'), (snap) => setProducts(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'customers'), (snap) => setCustomers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'orders'), (snap) => { let loadedOrders = snap.docs.map(d => ({ id: d.id, ...d.data() })); loadedOrders.sort((a, b) => b.date - a.date); setOrders(loadedOrders); });
                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'qrs'), (snap) => setQrs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                onSnapshot(collection(db.current, 'tenants', currentTenantId, 'team'), (snap) => setTeam(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const qMsg = query(collection(db.current, 'tenants', currentTenantId, 'messages'), orderBy('timestamp', 'asc'), limit(50));
                onSnapshot(qMsg, (snap) => { setMessages(snap.docs.map(d => ({ id: d.id, ...d.data() }))); });
                setLoading(false);
            };

            const saveData = async (coll, data, id) => {
                const { addDoc, collection, doc, updateDoc } = window.firebaseModules;
                if (!tenantId) throw new Error('No tenant ID');
                const ref = collection(db.current, 'tenants', tenantId, coll);
                if (id) await updateDoc(doc(db.current, 'tenants', tenantId, coll, id), data);
                else return await addDoc(ref, data);
            };

            const deleteData = async (coll, id) => {
                if (user.role !== ROLES.ADMIN) return alert("‚õî ACCESO DENEGADO");
                const { deleteDoc, doc } = window.firebaseModules;
                if (!tenantId) throw new Error('No tenant ID');
                if (confirm("¬øEst√°s seguro de eliminar este registro?")) await deleteDoc(doc(db.current, 'tenants', tenantId, coll, id));
            };

            const handleLogin = async () => {
                setLoginError('');

                // Detectar si es email o usuario
                const isEmail = loginUser.includes('@');

                if (isEmail) {
                    // LOGIN CON EMAIL + CONTRASE√ëA (Firebase Auth - OWNER)
                    try {
                        const { getAuth, signInWithEmailAndPassword, getFirestore, getDoc, doc, setDoc, serverTimestamp } = window.firebaseModules;
                        let authInstance;
                        try {
                            authInstance = getAuth();
                        } catch {
                            const { initializeApp } = window.firebaseModules;
                            const cfg = JSON.parse(__firebase_config);
                            const app = initializeApp(cfg);
                            authInstance = getAuth(app);
                        }

                        // Intentar login con Firebase Auth
                        const userCredential = await signInWithEmailAndPassword(authInstance, loginUser, loginPin);
                        const firebaseUser = userCredential.user;

                        // Configurar tenantId √∫nico para este usuario
                        const userTenantId = `tenant_${firebaseUser.uid}`;
                        setTenantId(userTenantId);

                        // Verificar si existe metadata del tenant, si no crearla
                        const dbInstance = db.current || getFirestore();
                        const tenantRef = doc(dbInstance, 'tenants', userTenantId);
                        const tenantSnap = await getDoc(tenantRef);

                        if (!tenantSnap.exists()) {
                            // Crear tenant por primera vez
                            await setDoc(tenantRef, {
                                ownerId: firebaseUser.uid,
                                ownerEmail: firebaseUser.email,
                                ownerName: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                                plan: 'premium',
                                status: 'active',
                                createdAt: serverTimestamp(),
                                lastLogin: serverTimestamp()
                            });
                            console.log('Tenant creado:', userTenantId);
                        } else {
                            // Actualizar √∫ltimo login
                            await setDoc(tenantRef, { lastLogin: serverTimestamp() }, { merge: true });
                        }

                        // Crear usuario temporal con permisos de admin
                        const adminUser = {
                            id: firebaseUser.uid,
                            name: firebaseUser.displayName || firebaseUser.email.split('@')[0],
                            email: firebaseUser.email,
                            role: ROLES.ADMIN,
                            permissions: PERMISSIONS_LIST.map(p => p.id),
                            image: firebaseUser.photoURL || null,
                            locationId: 'all',
                            isOwner: true,
                            tenantId: userTenantId
                        };

                        setUser(adminUser);
                        console.log('Login exitoso con email:', firebaseUser.email, 'Tenant:', userTenantId);

                    } catch (error) {
                        console.error('Error login email:', error);
                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                            setLoginError('Email o contrase√±a incorrectos');
                        } else if (error.code === 'auth/user-not-found') {
                            setLoginError('Usuario no encontrado');
                        } else if (error.code === 'auth/invalid-email') {
                            setLoginError('Email inv√°lido');
                        } else if (error.code === 'auth/too-many-requests') {
                            setLoginError('Demasiados intentos. Intenta m√°s tarde');
                        } else {
                            setLoginError('Error al iniciar sesi√≥n: ' + (error.message || 'Desconocido'));
                        }
                    }

                } else {
                    // LOGIN CON USUARIO + PIN (Sistema interno - EMPLEADO)
                    // Usar tenantId actual (del owner)
                    if (!tenantId) {
                        setLoginError('Error: No hay sesi√≥n de owner activa');
                        return;
                    }

                    const { collection, getDocs } = window.firebaseModules;
                    const teamRef = collection(db.current, 'tenants', tenantId, 'team');
                    const snap = await getDocs(teamRef);
                    const members = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                    if (members.length === 0) {
                        const defaultUser = { name: 'Admin', role: ROLES.ADMIN, pin: '123456', permissions: PERMISSIONS_LIST.map(p => p.id), image: null, locationId: 'all' };
                        const docRef = await saveData('team', defaultUser);
                        setUser({ ...defaultUser, id: docRef.id });
                        return;
                    }

                    const foundUser = members.find(m => m.name.toLowerCase() === loginUser.toLowerCase() && m.pin === loginPin);
                    if (foundUser) {
                        setUser(foundUser);
                        if (foundUser.locationId && foundUser.locationId !== 'all') {
                            setCurrentLocation(foundUser.locationId);
                        }
                    } else {
                        setLoginError('Usuario o PIN incorrectos');
                    }
                }
            };

            const handleLogout = () => { setUser(null); setLoginPin(''); setLoginUser(''); setCurrentView('home'); };

            const hasAccess = (moduleId) => {
                if (!user) return false;
                if (user.role === ROLES.ADMIN) return true;
                if (moduleId === 'waiter' && user.role === ROLES.WAITER) return true;
                if (moduleId === 'chat') return true;
                return user.permissions?.includes(moduleId);
            };

            const checkLocation = (item) => {
                if (currentLocation === 'all') return true;
                const itemLoc = item.locationId || 'main';
                return itemLoc === currentLocation;
            };

            const getCurrentMode = () => {
                if (currentLocation === 'all') return 'normal';
                const loc = config.locations.find(l => l.id === currentLocation);
                return loc?.mode || 'normal';
            };

            const showCustomAlert = (message, type = 'info', duration = 3000) => {
                const id = Date.now() + Math.random();
                const newAlert = { id, message, type, duration };
                setCustomAlerts(prev => [...prev, newAlert]);
                setTimeout(() => {
                    setCustomAlerts(prev => prev.filter(alert => alert.id !== id));
                }, duration);
            };

            const HomeView = () => {
                const filteredOrders = orders.filter(checkLocation);
                const filteredCustomers = customers.filter(checkLocation);
                const today = new Date().toDateString();
                const todaySales = filteredOrders.filter(o => new Date(o.date).toDateString() === today && o.status === 'Completado').reduce((acc, o) => acc + o.total, 0);
                const pendingOrders = filteredOrders.filter(o => o.status === 'Pendiente' || o.status === 'Comanda' || o.status === 'En Proceso').length;

                return (
                    <div className="scroll-view">
                        <div className="p-4 md:p-6 pb-32 space-y-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-3xl font-bold text-emerald-900 dark:text-emerald-100">Hola, {user.name} üëã</h2>
                                    <p className="text-gray-500 dark:text-gray-400">
                                        {currentLocation === 'all' ? 'Vista Global' : config.locations.find(l => l.id === currentLocation)?.name || 'Sucursal'}
                                        {currentLocation !== 'all' && <span className="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-slate-700 text-xs rounded-full uppercase font-bold">{getCurrentMode()}</span>}
                                    </p>
                                </div>
                            </div>
                            {user.role !== ROLES.WAITER && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-emerald-600 dark:bg-emerald-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                                        <div className="relative z-10"><p className="text-emerald-100 text-sm font-medium mb-1">Ventas de Hoy</p><h3 className="text-4xl font-bold">{formatMoney(todaySales, config.currency)}</h3></div>
                                        <DollarSign className="absolute -right-4 -bottom-4 text-emerald-500 opacity-50" size={100} />
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-emerald-100 dark:border-slate-700 relative overflow-hidden">
                                        <div className="relative z-10"><p className="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">Pedidos Pendientes</p><h3 className="text-3xl font-bold text-gray-800 dark:text-gray-100">{pendingOrders}</h3></div>
                                        <ClipboardList className="absolute -right-4 -bottom-4 text-gray-100 dark:text-slate-700" size={100} />
                                    </div>
                                    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-emerald-100 dark:border-slate-700 relative overflow-hidden">
                                        <div className="relative z-10"><p className="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">Total Clientes</p><h3 className="text-3xl font-bold text-gray-800 dark:text-gray-100">{filteredCustomers.length}</h3></div>
                                        <Users className="absolute -right-4 -bottom-4 text-gray-100 dark:text-slate-700" size={100} />
                                    </div>
                                </div>
                            )}
                            <h3 className="text-xl font-bold text-emerald-900 dark:text-emerald-100 mt-4">Accesos R√°pidos</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {hasAccess('pos') && <button onClick={() => setCurrentView('pos')} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border dark:border-slate-700 hover:shadow-md transition flex flex-col items-center gap-3 group"><div className="p-4 rounded-full bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition"><LayoutDashboard size={32} /></div><span className="font-bold text-gray-700 dark:text-gray-200">Punto de Venta</span></button>}
                                {hasAccess('verification') && <button onClick={() => setCurrentView('verification')} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border dark:border-slate-700 hover:shadow-md transition flex flex-col items-center gap-3 group"><div className="p-4 rounded-full bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 group-hover:bg-purple-600 group-hover:text-white transition"><CheckSquare size={32} /></div><span className="font-bold text-gray-700 dark:text-gray-200 text-center text-xs">Verif. Digital</span></button>}
                                {hasAccess('orders') && <button onClick={() => setCurrentView('orders')} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border dark:border-slate-700 hover:shadow-md transition flex flex-col items-center gap-3 group"><div className="p-4 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 group-hover:bg-blue-600 group-hover:text-white transition"><ClipboardList size={32} /></div><span className="font-bold text-gray-700 dark:text-gray-200">Pedidos</span></button>}
                                {hasAccess('alerts') && <button onClick={() => setCurrentView('alerts')} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border dark:border-slate-700 hover:shadow-md transition flex flex-col items-center gap-3 group"><div className="p-4 rounded-full bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 group-hover:bg-red-600 group-hover:text-white transition"><AlertTriangle size={32} /></div><span className="font-bold text-gray-700 dark:text-gray-200">Alertas</span></button>}
                            </div>
                        </div>
                    </div>
                );
            };

            const AlertsView = () => {
                const [selectedFolder, setSelectedFolder] = useState(null);
                const [innerSearch, setInnerSearch] = useState("");
                const appMode = getCurrentMode();
                const baseDebtors = useMemo(() => {
                    const filteredCust = customers.filter(checkLocation);
                    const filteredOrd = orders.filter(checkLocation);
                    const withDebt = filteredCust.filter(c => c.credit > 0);
                    const now = new Date();
                    const result = [];
                    withDebt.forEach(customer => {
                        const customerOrders = filteredOrd.filter(o => o.customerId === customer.id && (o.method === 'Credit' || o.method === 'Cargo Manual')).sort((a, b) => a.date - b.date);
                        if (customerOrders.length > 0) {
                            const oldestOrder = customerOrders[0];
                            const diffTime = Math.abs(now - new Date(oldestOrder.date));
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            let summary = oldestOrder.method === 'Cargo Manual' ? "Cargo Manual / Ajuste" : oldestOrder.items.map(i => `${i.quantity} ${i.name}`).join(', ');
                            result.push({ ...customer, daysOverdue: diffDays, oldestOrderDate: oldestOrder.date, itemsSummary: summary });
                        }
                    });
                    return result.sort((a, b) => b.daysOverdue - a.daysOverdue);
                }, [customers, orders, currentLocation]);

                const folders = useMemo(() => {
                    if (appMode !== 'kiosk') return [];
                    const grouped = {};
                    baseDebtors.forEach(d => {
                        const key = `${d.level || 'Sin Nivel'}|${d.grade || 'Sin Grado'}|${d.section || 'Sin Sec'}`;
                        if (!grouped[key]) grouped[key] = { level: d.level, grade: d.grade, section: d.section, totalDebt: 0, count: 0, students: [] };
                        grouped[key].totalDebt += d.credit; grouped[key].count += 1; grouped[key].students.push(d);
                    });
                    return Object.values(grouped).sort((a, b) => {
                        if (a.level !== b.level) return a.level === 'Primaria' ? -1 : 1;
                        if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                        return a.section.localeCompare(b.section);
                    });
                }, [baseDebtors, appMode]);

                const getWhatsAppLink = (debtor) => {
                    if (!debtor.phone) return '#';
                    const phone = debtor.phone.replace(/\D/g, '');
                    let greeting = `Hola ${debtor.name}`;
                    let relation = "";
                    if (appMode === 'kiosk' && debtor.guardian) { greeting = `Hola ${debtor.guardian}`; relation = ` de su hijo(a) ${debtor.name}`; }
                    const message = `${greeting}, le escribimos de ${config.storeName}. Se tiene una deuda pendiente${relation} de ${formatMoney(debtor.credit, config.currency)} con una antig√ºedad de ${debtor.daysOverdue} d√≠as. Detalle de origen: ${debtor.itemsSummary}. Por favor regularizar su pago.`;
                    return `https://wa.me/51${phone}?text=${encodeURIComponent(message)}`;
                };

                if (selectedFolder) {
                    const filteredStudents = selectedFolder.students.filter(s => s.name.toLowerCase().includes(innerSearch.toLowerCase()));
                    return (
                        <div className="scroll-view h-full flex flex-col bg-gray-50 dark:bg-slate-900">
                            <div className="p-4 bg-white dark:bg-slate-800 shadow-sm border-b dark:border-slate-700 flex gap-3 items-center sticky top-0 z-10">
                                <button onClick={() => setSelectedFolder(null)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full hover:bg-gray-200 transition"><ChevronLeft size={24} className="text-gray-600 dark:text-gray-300" /></button>
                                <div><h3 className="font-bold text-lg text-emerald-900 dark:text-white leading-tight">{selectedFolder.level} {selectedFolder.grade} "{selectedFolder.section}"</h3><p className="text-xs text-gray-500 dark:text-gray-400">Total Deuda: {formatMoney(selectedFolder.totalDebt, config.currency)}</p></div>
                            </div>
                            <div className="p-4"><input className="w-full p-3 mb-4 rounded-xl border dark:border-slate-600 shadow-sm outline-none focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:text-white" placeholder="Buscar alumno..." value={innerSearch} onChange={e => setInnerSearch(e.target.value)} />
                                <div className="space-y-3">{filteredStudents.map(d => (<div key={d.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 border-red-500 flex flex-col gap-3"><div className="flex justify-between items-start"><div><h4 className="font-bold text-gray-800 dark:text-white">{d.name}</h4>{d.guardian && <p className="text-xs text-gray-500 dark:text-gray-400">Apod: {d.guardian}</p>}</div><div className="text-right"><span className="font-bold text-red-600 dark:text-red-400 text-lg">{formatMoney(d.credit, config.currency)}</span><p className="text-[10px] text-gray-400">{d.daysOverdue} d√≠as atraso</p></div></div>{d.phone ? (<a href={getWhatsAppLink(d)} target="_blank" className="bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">{MessageSquare && <MessageSquare size={16} />} Cobrar a {d.guardian ? 'Apoderado' : 'Alumno'}</a>) : <div className="text-center text-xs text-gray-400 bg-gray-100 dark:bg-slate-700 py-1 rounded">Sin tel√©fono</div>}</div>))}</div></div></div>
                    );
                }
                return (
                    <div className="scroll-view"><div className="p-4 md:p-6 pb-32 space-y-6"><h2 className="text-2xl font-bold text-red-700 dark:text-red-400 flex items-center gap-2">{AlertTriangle && <AlertTriangle />} Alertas de Cobranza</h2>
                        {appMode === 'kiosk' && (<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{folders.length === 0 && <p className="col-span-full text-center text-gray-500">No hay deudas pendientes.</p>}{folders.map((f, idx) => (<div key={idx} onClick={() => setSelectedFolder(f)} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-emerald-100 dark:border-slate-700 hover:shadow-md transition cursor-pointer flex items-center gap-4 relative overflow-hidden group"><div className="bg-amber-100 dark:bg-amber-900/30 p-3 rounded-lg text-amber-600 dark:text-amber-400">{Folder && <Folder size={32} />}</div><div className="flex-1"><h3 className="font-bold text-gray-800 dark:text-white">{f.grade} "{f.section}" <span className="text-xs font-normal text-gray-500">({f.level})</span></h3><p className="text-sm text-gray-500 dark:text-gray-400">{f.count} Alumnos</p><p className="text-sm font-bold text-red-600 dark:text-red-400 mt-1">{formatMoney(f.totalDebt, config.currency)}</p></div>{ChevronRight && <ChevronRight className="text-gray-300 group-hover:text-emerald-500 transition" />}</div>))}</div>)}
                        {appMode !== 'kiosk' && (<div className="space-y-4">{baseDebtors.length === 0 && <p className="text-center text-gray-500 py-10">No hay deudas antiguas.</p>}{baseDebtors.map(d => (<div key={d.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 border-red-500 flex flex-col md:flex-row justify-between items-center gap-4"><div className="flex-1 w-full"><div className="flex justify-between"><h3 className="font-bold text-lg dark:text-white">{d.name}</h3><span className="font-bold text-red-600 dark:text-red-400 text-lg md:hidden">{formatMoney(d.credit, config.currency)}</span></div><p className="text-sm text-gray-500 dark:text-gray-400 mb-2">{d.phone || 'Sin celular'}</p><div className="bg-red-50 dark:bg-red-900/20 p-2 rounded text-xs text-red-800 dark:text-red-300 flex gap-2 items-center">{Clock && <Clock size={14} />} {d.daysOverdue} d√≠as de atraso</div></div><div className="hidden md:block text-right"><span className="block text-xs font-bold text-red-500 uppercase">Deuda Total</span><span className="text-xl font-bold text-gray-800 dark:text-gray-200">{formatMoney(d.credit, config.currency)}</span></div>{d.phone ? (<a href={getWhatsAppLink(d)} target="_blank" className="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition shadow-md whitespace-nowrap">{MessageSquare && <MessageSquare size={18} />} Cobrar</a>) : (<button disabled className="w-full md:w-auto bg-gray-200 dark:bg-slate-700 text-gray-400 px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2 cursor-not-allowed">{Ban && <Ban size={18} />}</button>)}</div>))}</div>)}
                    </div></div>
                );
            };

            const ChatView = () => {
                const [newMessage, setNewMessage] = useState("");
                const chatEndRef = useRef(null);
                useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);
                const sendMessage = async (e) => { e.preventDefault(); if (!newMessage.trim()) return; await saveData('messages', { text: newMessage, senderId: user.id || user.uid, senderName: user.name, role: user.role, timestamp: Date.now() }); setNewMessage(""); };
                return (<div className="flex flex-col h-full bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 overflow-hidden m-4"><div className="p-4 border-b dark:border-slate-700 bg-emerald-50 dark:bg-slate-900 flex justify-between items-center"><h2 className="font-bold text-emerald-900 dark:text-emerald-100 flex items-center gap-2">{MessageSquare && <MessageSquare size={20} />} Chat de Equipo</h2><span className="text-xs text-emerald-600 dark:text-emerald-400 bg-white dark:bg-slate-800 px-2 py-1 rounded-full border border-emerald-200 dark:border-slate-600">En l√≠nea</span></div><div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-slate-900/50">{messages.map(msg => { const isMe = msg.senderId === (user.id || user.uid); return (<div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}><div className={`max-w-[80%] p-3 rounded-xl shadow-sm ${isMe ? 'bg-emerald-600 text-white rounded-br-none' : 'bg-white dark:bg-slate-700 text-gray-800 dark:text-gray-100 border dark:border-slate-600 rounded-bl-none'}`}>{!isMe && <p className="text-xs font-bold text-emerald-600 dark:text-emerald-400 mb-1">{msg.senderName} <span className="font-normal text-gray-400">({msg.role})</span></p>}<p className="text-sm">{msg.text}</p></div><span className="text-[10px] text-gray-400 mt-1 mx-1">{new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></div>); })}<div ref={chatEndRef} /></div><form onSubmit={sendMessage} className="p-3 bg-white dark:bg-slate-800 border-t dark:border-slate-700 flex gap-2"><input className="flex-1 p-3 border dark:border-slate-600 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-50 dark:bg-slate-700 dark:text-white" placeholder="Escribe un mensaje..." value={newMessage} onChange={e => setNewMessage(e.target.value)} /><button type="submit" className="p-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition shadow-lg">{Send && <Send size={20} />}</button></form></div>);
            };

            const MenuView = () => {
                // Estado del Pedido Actual (Local)
                const [menuList, setMenuList] = useState([]);

                // Estado de la Configuraci√≥n del D√≠a (Desde Firebase)
                const [dailyDishes, setDailyDishes] = useState([]);
                const [menuPrice, setMenuPrice] = useState(15.00);
                const [configId, setConfigId] = useState(null); // ID del documento en Firebase

                // Formularios
                const [newItemName, setNewItemName] = useState("");
                const [newItemType, setNewItemType] = useState("Segundo");
                const [tab, setTab] = useState("combinations");
                const [mobileTab, setMobileTab] = useState('menu');

                // Estados para confirmaci√≥n y opciones
                const [showConfirmation, setShowConfirmation] = useState(false);
                const [showOptions, setShowOptions] = useState(false);
                const [pendingOrder, setPendingOrder] = useState(null);

                // --- CONEXI√ìN FIREBASE: Cargar Men√∫ del D√≠a ---
                useEffect(() => {
                    const { collection, onSnapshot, doc } = window.firebaseModules;
                    // Escuchamos un documento espec√≠fico llamado 'today' en la colecci√≥n 'daily_menu'
                    const unsub = onSnapshot(collection(db.current, 'artifacts', appId, 'public', 'data', 'daily_menu'), (snap) => {
                        if (!snap.empty) {
                            const data = snap.docs[0].data();
                            setDailyDishes(data.dishes || []);
                            setMenuPrice(data.price || 15.00);
                            setConfigId(snap.docs[0].id);
                        }
                    });
                    return () => unsub();
                }, []);

                // --- Funci√≥n para GUARDAR cambios en Firebase ---
                const saveMenuToCloud = async (newDishes, newPrice) => {
                    const dataToSave = { dishes: newDishes, price: parseFloat(newPrice) };
                    // Si ya existe un ID, actualizamos. Si no, creamos uno nuevo.
                    if (configId) {
                        await saveData('daily_menu', dataToSave, configId);
                    } else {
                        const ref = await saveData('daily_menu', dataToSave);
                        setConfigId(ref.id);
                    }
                };

                const addDailyOption = async () => {
                    if (!newItemName) return alert("Escribe el nombre del plato");
                    const newOption = { id: Date.now(), name: newItemName, type: newItemType };
                    const newDishes = [...dailyDishes, newOption];

                    setDailyDishes(newDishes); // Actualizamos visualmente r√°pido
                    setNewItemName("");
                    await saveMenuToCloud(newDishes, menuPrice); // Guardamos en la nube
                };

                const removeDailyOption = async (id) => {
                    const newDishes = dailyDishes.filter(d => d.id !== id);
                    setDailyDishes(newDishes);
                    await saveMenuToCloud(newDishes, menuPrice);
                };

                const handlePriceChange = async (e) => {
                    const val = e.target.value;
                    setMenuPrice(val);
                    // Usamos un timeout peque√±o para no saturar la base de datos mientras escribes
                    // Pero para simplificar, guardaremos al perder el foco (onBlur)
                };

                const savePriceOnBlur = async () => {
                    await saveMenuToCloud(dailyDishes, menuPrice);
                };

                // --- L√ìGICA DE COMBINACIONES ---
                const mains = dailyDishes.filter(d => d.type === 'Segundo');
                const starters = dailyDishes.filter(d => d.type === 'Entrada');
                const others = dailyDishes.filter(d => d.type !== 'Segundo' && d.type !== 'Entrada');

                const combinations = useMemo(() => {
                    const combos = [];
                    mains.forEach(main => {
                        starters.forEach(starter => {
                            combos.push({
                                id: `${main.id}-${starter.id}`,
                                name: `${main.name} CON ${starter.name}`,
                                category: 'Men√∫ Completo',
                                price: parseFloat(menuPrice),
                                obs: ''
                            });
                        });
                    });
                    return combos;
                }, [dailyDishes, menuPrice]);

                const addToOrder = (item) => {
                    setMenuList([...menuList, { ...item, internalId: Date.now() }]);
                };

                const removeItem = (internalId) => setMenuList(menuList.filter(i => i.internalId !== internalId));

                const updateItemPrice = (internalId, newPrice) => {
                    setMenuList(prev => prev.map(item => item.internalId === internalId ? { ...item, price: parseFloat(newPrice) || 0 } : item));
                };

                const totalMenu = menuList.reduce((acc, item) => acc + item.price, 0);

                // Mostrar confirmaci√≥n antes de guardar
                const startSaveOrder = () => {
                    if (menuList.length === 0) return showCustomAlert("‚ö†Ô∏è La lista est√° vac√≠a", 'warning');

                    const orderData = {
                        items: menuList.map(i => ({
                            name: i.category === 'Men√∫ Completo' ? `[Men√∫] ${i.name}` : `[${i.type || 'Carta'}] ${i.name}`,
                            quantity: 1,
                            price: i.price,
                            category: i.category
                        })),
                        total: totalMenu,
                        date: Date.now(),
                        customerId: 'menu_dia',
                        customerName: 'Cliente Men√∫',
                        status: 'Comanda', // Cambiado de 'Completado' a 'Comanda' para que aparezca en cocina
                        method: 'Efectivo',
                        sellerId: user.uid || user.id,
                        locationId: currentLocation,
                        sentToKitchen: false
                    };

                    setPendingOrder(orderData);
                    setShowConfirmation(true);
                };

                // Guardar orden despu√©s de confirmaci√≥n
                const handleSaveOrder = async (sendToKitchen = false) => {
                    try {
                        console.log('üíæ Guardando orden, sendToKitchen:', sendToKitchen);
                        console.log('üìã pendingOrder:', pendingOrder);
                        console.log('üçΩÔ∏è menuList:', menuList);

                        const savedMenuList = [...menuList]; // Guardar antes de limpiar

                        // Orden para Firebase (sin savedItems)
                        const orderToSave = { ...pendingOrder, sentToKitchen: sendToKitchen };
                        console.log('üì§ Enviando a Firebase:', orderToSave);

                        await saveData('orders', orderToSave);

                        // Orden para estado local (con savedItems para el PDF)
                        const finalOrder = { ...orderToSave, savedItems: savedMenuList };

                        console.log('‚úÖ Orden guardada exitosamente');
                        showCustomAlert('‚úÖ Orden registrada exitosamente', 'success');
                        setShowConfirmation(false);
                        setMenuList([]);
                        setPendingOrder(finalOrder); // Actualizar con los items guardados

                        // Mostrar opciones de PDF y cocina
                        setShowOptions(true);
                    } catch (error) {
                        console.error('‚ùå Error guardando orden:', error);
                        console.error('Error completo:', error.message, error.stack);
                        showCustomAlert('‚ùå Error al guardar orden', 'error');
                    }
                };

                // Cerrar opciones y limpiar
                const closeOptions = () => {
                    setShowOptions(false);
                    setPendingOrder(null);
                };

                return (
                    <div className="flex flex-col md:flex-row h-full overflow-hidden bg-gray-50 dark:bg-slate-900 relative">

                        {/* 1. CONFIGURACI√ìN (IZQUIERDA) */}
                        <div className={`w-full md:w-1/4 p-4 bg-white dark:bg-slate-800 border-r dark:border-slate-700 flex-col gap-4 overflow-y-auto 
                            ${mobileTab === 'config' ? 'flex h-full pb-24' : 'hidden md:flex'}`}>

                            <h3 className="font-bold text-emerald-800 dark:text-emerald-100 flex items-center gap-2">{Settings && <Settings size={18} />} Configurar D√≠a (Global)</h3>
                            <p className="text-[10px] text-gray-400">Los cambios se ver√°n en todos los dispositivos.</p>

                            <div className="bg-emerald-50 dark:bg-slate-700 p-3 rounded-lg">
                                <label className="text-xs font-bold text-emerald-800 dark:text-emerald-200">Precio del Men√∫ S/</label>
                                <input type="number" className="w-full p-2 mt-1 rounded border dark:border-slate-600 font-bold text-lg dark:bg-slate-800 dark:text-white"
                                    value={menuPrice} onChange={handlePriceChange} onBlur={savePriceOnBlur} />
                            </div>

                            <div className="border-t pt-4 dark:border-slate-600">
                                <label className="text-xs font-bold text-gray-500 mb-1 block">Agregar Plato/Bebida</label>
                                <div className="flex gap-1 mb-2">
                                    <select className="text-xs p-2 border rounded dark:bg-slate-700 dark:text-white" value={newItemType} onChange={e => setNewItemType(e.target.value)}>
                                        <option value="Segundo">Segundo</option>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Bebida">Bebida</option>
                                        <option value="Extra">Extra</option>
                                    </select>
                                </div>
                                <div className="flex gap-1">
                                    <input className="flex-1 p-2 border rounded text-sm dark:bg-slate-700 dark:text-white" placeholder="Ej: Lomo Saltado"
                                        value={newItemName} onChange={e => setNewItemName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addDailyOption()} />
                                    <button onClick={addDailyOption} className="bg-emerald-600 text-white p-2 rounded"><Plus size={18} /></button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto space-y-2">
                                <p className="text-xs font-bold text-gray-400 uppercase">Opciones Disponibles:</p>
                                {dailyDishes.map(dish => (
                                    <div key={dish.id} className="flex justify-between items-center text-sm p-2 bg-gray-50 dark:bg-slate-700 rounded border dark:border-slate-600">
                                        <div>
                                            <span className={`text-[10px] px-1 rounded mr-1 ${dish.type === 'Segundo' ? 'bg-orange-100 text-orange-800' : (dish.type === 'Entrada' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800')}`}>{dish.type.charAt(0)}</span>
                                            <span className="dark:text-white">{dish.name}</span>
                                        </div>
                                        <button onClick={() => removeDailyOption(dish.id)} className="text-red-400 hover:text-red-600"><X size={14} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 2. SELECCI√ìN (CENTRO) */}
                        <div className={`flex-1 flex-col h-full overflow-hidden bg-gray-100 dark:bg-slate-900 
                            ${mobileTab === 'menu' ? 'flex pb-24 md:pb-0' : 'hidden md:flex'}`}>

                            <div className="p-2 bg-white dark:bg-slate-800 shadow-sm flex gap-2">
                                <button onClick={() => setTab('combinations')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${tab === 'combinations' ? 'bg-emerald-600 text-white shadow' : 'bg-gray-100 dark:bg-slate-700 text-gray-500'}`}>Men√∫ Completo</button>
                                <button onClick={() => setTab('individual')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition ${tab === 'individual' ? 'bg-emerald-600 text-white shadow' : 'bg-gray-100 dark:bg-slate-700 text-gray-500'}`}>Por Separado</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4">
                                {tab === 'combinations' ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {combinations.length === 0 && <div className="col-span-full text-center text-gray-400 mt-10 p-4 border-2 border-dashed rounded-xl">Agrega "Segundos" y "Entradas" en la pesta√±a Configuraci√≥n para ver combinaciones.</div>}
                                        {combinations.map(combo => (
                                            <button key={combo.id} onClick={() => addToOrder(combo)} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-emerald-100 dark:border-slate-700 hover:shadow-md hover:border-emerald-500 transition text-left group relative active:scale-95">
                                                <h4 className="font-bold text-emerald-900 dark:text-emerald-100 group-hover:text-emerald-600 leading-tight">{combo.name}</h4>
                                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Men√∫ Completo</p>
                                                <div className="absolute top-2 right-2 bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded-full">{formatMoney(combo.price, config.currency)}</div>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        <div>
                                            <h4 className="font-bold text-gray-500 mb-2 uppercase text-xs">Solo Segundos</h4>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                {mains.map(m => (
                                                    <button key={m.id} onClick={() => addToOrder({ ...m, price: parseFloat(menuPrice), category: 'Segundo' })} className="p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border text-left hover:border-orange-500 active:scale-95 transition">
                                                        <span className="font-bold dark:text-white block">{m.name}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-500 mb-2 uppercase text-xs">Solo Entradas / Bebidas / Extras</h4>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                {[...starters, ...others].map(m => (
                                                    <button key={m.id} onClick={() => addToOrder({ ...m, price: 0, category: m.type })} className="p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border text-left hover:border-blue-500 active:scale-95 transition">
                                                        <span className="font-bold dark:text-white block">{m.name}</span>
                                                        <span className="block text-[10px] text-gray-400">{m.type}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 3. RESUMEN DEL PEDIDO (DERECHA) */}
                        <div className={`w-full md:w-80 bg-white dark:bg-slate-800 border-l dark:border-slate-700 flex-col h-full 
                            ${mobileTab === 'order' ? 'flex pb-24 md:pb-0' : 'hidden md:flex'}`}>

                            <div className="p-4 bg-gray-50 dark:bg-slate-900 border-b dark:border-slate-700 flex justify-between items-center">
                                <div><h3 className="font-bold text-lg dark:text-white">Pedido Actual</h3><p className="text-xs text-gray-500">{menuList.length} √≠tems</p></div>
                                <span className="text-2xl font-bold text-emerald-600">{formatMoney(totalMenu, config.currency)}</span>
                            </div>

                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {menuList.length === 0 && <p className="text-center text-gray-400 mt-10 text-sm">Selecciona opciones...</p>}
                                {menuList.map((item) => (
                                    <div key={item.internalId} className="bg-white dark:bg-slate-700 p-2 rounded shadow-sm border dark:border-slate-600 flex justify-between items-start group">
                                        <div className="flex-1">
                                            <p className="font-bold text-sm text-gray-800 dark:text-white leading-tight">{item.name}</p>
                                            <span className="text-[10px] bg-gray-100 dark:bg-slate-600 px-1 rounded text-gray-500">{item.category}</span>
                                        </div>
                                        <div className="text-right ml-2 flex flex-col items-end">
                                            <input type="number" className="w-16 text-right text-sm font-bold bg-transparent border-b border-gray-300 dark:border-slate-500 outline-none focus:border-emerald-500 dark:text-emerald-400 mb-1 p-0"
                                                value={item.price} onChange={(e) => updateItemPrice(item.internalId, e.target.value)} onClick={(e) => e.stopPropagation()} />
                                            <button onClick={() => removeItem(item.internalId)} className="text-red-400 hover:text-red-600 text-xs p-1"><Trash2 size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="p-4 border-t dark:border-slate-700">
                                <button onClick={startSaveOrder} className="w-full bg-emerald-800 hover:bg-emerald-900 text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 transition active:scale-95"><CheckCircle2 /> Finalizar</button>
                            </div>
                        </div>

                        {/* --- BARRA DE NAVEGACI√ìN M√ìVIL --- */}
                        <div className="md:hidden fixed bottom-4 left-4 right-4 bg-white dark:bg-slate-800 rounded-full shadow-2xl border border-gray-100 dark:border-slate-700 p-1 flex z-40">
                            <button onClick={() => setMobileTab('config')} className={`flex-1 py-3 rounded-full text-xs font-bold flex flex-col items-center justify-center gap-1 transition-all ${mobileTab === 'config' ? 'bg-emerald-600 text-white shadow-md' : 'text-gray-500 dark:text-gray-400'}`}>{Settings && <Settings size={18} />} Config</button>
                            <button onClick={() => setMobileTab('menu')} className={`flex-1 py-3 rounded-full text-xs font-bold flex flex-col items-center justify-center gap-1 transition-all ${mobileTab === 'menu' ? 'bg-emerald-600 text-white shadow-md' : 'text-gray-500 dark:text-gray-400'}`}>{Utensils && <Utensils size={18} />} Carta</button>
                            <button onClick={() => setMobileTab('order')} className={`flex-1 py-3 rounded-full text-xs font-bold flex flex-col items-center justify-center gap-1 transition-all ${mobileTab === 'order' ? 'bg-emerald-600 text-white shadow-md' : 'text-gray-500 dark:text-gray-400'}`}>{ShoppingCart && <ShoppingCart size={18} />} Pedido ({menuList.length})</button>
                        </div>

                        {/* MODAL DE CONFIRMACI√ìN */}
                        {showConfirmation && pendingOrder && (
                            <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                                <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-scale-in">
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mx-auto mb-4 flex items-center justify-center"><span className="text-3xl">üçΩÔ∏è</span></div>
                                        <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">Confirmar Orden de Men√∫</h3>
                                        <p className="text-sm text-gray-500 dark:text-gray-400">Revisa los detalles antes de guardar</p>
                                    </div>
                                    <div className="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl mb-4">
                                        <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Cliente</p>
                                        <p className="text-lg font-bold text-gray-800 dark:text-white">{pendingOrder.customerName}</p>
                                    </div>
                                    <div className="mb-4 max-h-48 overflow-y-auto scroll-view">
                                        <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Productos</p>
                                        <div className="space-y-2">{pendingOrder.items.map((item, idx) => (<div key={idx} className="flex justify-between items-center text-sm bg-gray-50 dark:bg-slate-700 p-2 rounded-lg"><span className="text-gray-700 dark:text-gray-300">{item.name}</span><span className="font-bold text-gray-900 dark:text-white">{formatMoney(item.price, config.currency)}</span></div>))}</div>
                                    </div>
                                    <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 p-4 rounded-xl mb-6 text-white">
                                        <div className="flex justify-between items-center"><span className="text-sm opacity-90">Total</span><span className="text-2xl font-bold">{formatMoney(pendingOrder.total, config.currency)}</span></div>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={() => handleSaveOrder(false)} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2"><span>‚úÖ Guardar (Sin Cocina)</span></button>
                                        <button onClick={() => handleSaveOrder(true)} className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2"><span className="text-xl">üç≥</span><span>Guardar y Enviar a Cocina</span></button>
                                        <button onClick={() => setShowConfirmation(false)} className="w-full py-3 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-slate-600 transition">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* MODAL DE OPCIONES POST-GUARDADO */}
                        {showOptions && pendingOrder && (
                            <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                                <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-8 shadow-2xl animate-scale-in">
                                    <div className="text-center mb-6">
                                        <div className="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full mx-auto mb-4 flex items-center justify-center animate-bounce-once">{CheckCircle2 && <CheckCircle2 size={48} className="text-green-600 dark:text-green-400" />}</div>
                                        <h3 className="text-2xl font-bold text-gray-800 dark:text-white mb-2">¬°Orden Guardada!</h3>
                                        <p className="text-gray-500 dark:text-gray-400">La orden se registr√≥ correctamente</p>
                                    </div>
                                    <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6 rounded-xl mb-6 text-white text-center">
                                        <p className="text-sm opacity-90 mb-1">Total</p>
                                        <p className="text-4xl font-bold">{formatMoney(pendingOrder.total, config.currency)}</p>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={() => { PDFService.generateMenuTicket(pendingOrder.savedItems || [], pendingOrder.total, config); closeOptions(); }} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2">{Download && <Download size={20} />}<span>Descargar Ticket PDF</span></button>
                                        <button onClick={closeOptions} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition">Continuar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // Componente de Confirmaci√≥n PRE-VENTA
            const SaleConfirmation = ({ cart, customer, total, method, onConfirm, onCancel, currency }) => {
                const isCredit = method === 'Credit';
                const currentDebt = customer?.credit || 0;
                const newDebt = currentDebt + total;
                return (
                    <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-scale-in">
                            <div className="text-center mb-6">
                                <div className="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mx-auto mb-4 flex items-center justify-center"><span className="text-3xl">üìã</span></div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">Confirmar Venta</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400">Revisa los detalles antes de procesar</p>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl mb-4">
                                <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Cliente</p>
                                <p className="text-lg font-bold text-gray-800 dark:text-white">{customer?.name || 'Cliente Casual'}</p>
                                {isCredit && (
                                    <div className="mt-3 space-y-2 pt-3 border-t border-gray-200 dark:border-slate-600">
                                        <div className="flex justify-between text-sm"><span className="text-gray-600 dark:text-gray-400">Saldo Actual:</span><span className="font-bold text-red-600 dark:text-red-400">{formatMoney(currentDebt, currency)}</span></div>
                                        <div className="flex justify-between text-sm"><span className="text-gray-600 dark:text-gray-400">Nueva Compra:</span><span className="font-bold text-orange-600 dark:text-orange-400">+{formatMoney(total, currency)}</span></div>
                                        <div className="flex justify-between text-sm pt-2 border-t border-gray-200 dark:border-slate-600"><span className="text-gray-700 dark:text-gray-300 font-bold">Nuevo Saldo:</span><span className="font-bold text-xl text-red-600 dark:text-red-400">{formatMoney(newDebt, currency)}</span></div>
                                    </div>
                                )}
                            </div>
                            <div className="mb-4 max-h-48 overflow-y-auto scroll-view">
                                <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Productos</p>
                                <div className="space-y-2">{cart.map((item, idx) => (<div key={idx} className="flex justify-between items-center text-sm bg-gray-50 dark:bg-slate-700 p-2 rounded-lg"><span className="text-gray-700 dark:text-gray-300">{item.name} x{item.qty}</span><span className="font-bold text-gray-900 dark:text-white">{formatMoney(item.price * item.qty, currency)}</span></div>))}</div>
                            </div>
                            <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 p-4 rounded-xl mb-6 text-white">
                                <div className="flex justify-between items-center"><span className="text-sm opacity-90">Total a Pagar</span><span className="text-2xl font-bold">{formatMoney(total, currency)}</span></div>
                                <div className="text-xs opacity-75 mt-1">M√©todo: {method}</div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={onCancel} className="py-3 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-slate-600 transition">Cancelar</button>
                                <button onClick={onConfirm} className="py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2"><span>Confirmar</span>{CheckCircle2 && <CheckCircle2 size={20} />}</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Componente de Comprobante POST-VENTA
            const SaleReceipt = ({ customer, total, method, newDebt, onClose, onPrintReceipt, currency }) => {
                const isCredit = method === 'Credit';
                return (
                    <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-8 shadow-2xl animate-scale-in">
                            <div className="text-center mb-6">
                                <div className="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full mx-auto mb-4 flex items-center justify-center animate-bounce-once">{CheckCircle2 && <CheckCircle2 size={48} className="text-green-600 dark:text-green-400" />}</div>
                                <h3 className="text-2xl font-bold text-gray-800 dark:text-white mb-2">¬°Hecho!</h3>
                                <p className="text-gray-500 dark:text-gray-400">Venta procesada exitosamente</p>
                            </div>
                            <div className="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl mb-4 text-center">
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">Cliente</p>
                                <p className="text-xl font-bold text-gray-800 dark:text-white">{customer?.name || 'Cliente Casual'}</p>
                            </div>
                            {isCredit && newDebt !== undefined ? (
                                <div className="bg-gradient-to-r from-red-500 to-red-600 p-6 rounded-xl mb-6 text-white text-center">
                                    <p className="text-sm opacity-90 mb-1">Nuevo Saldo a Deber</p>
                                    <p className="text-4xl font-bold">{formatMoney(newDebt, currency)}</p>
                                    <p className="text-xs opacity-75 mt-2">Pago a cr√©dito registrado</p>
                                </div>
                            ) : (
                                <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6 rounded-xl mb-6 text-white text-center">
                                    <p className="text-sm opacity-90 mb-1">Monto Pagado</p>
                                    <p className="text-4xl font-bold">{formatMoney(total, currency)}</p>
                                    <p className="text-xs opacity-75 mt-2">Pago {method} procesado</p>
                                </div>
                            )}
                            <div className="space-y-3">
                                <button onClick={onPrintReceipt} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2">{Download && <Download size={20} />}<span>Descargar Recibo PDF</span></button>
                                <button onClick={onClose} className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition">Continuar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Funci√≥n para generar recibo PDF
            const generateReceiptPDF = (order, config) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(22); doc.setTextColor(16, 185, 129); doc.text('RECIBO DE VENTA', 105, 20, { align: 'center' });
                    doc.setFontSize(10); doc.setTextColor(100);
                    doc.text(config.storeName, 105, 30, { align: 'center' }); doc.text(config.address || '', 105, 36, { align: 'center' }); doc.text(config.phone || '', 105, 42, { align: 'center' });
                    doc.setDrawColor(200); doc.line(20, 48, 190, 48);
                    let y = 58;
                    doc.setFontSize(10); doc.setTextColor(0);
                    doc.text(`Fecha: ${new Date(order.date).toLocaleString('es-PE')}`, 20, y); y += 6;
                    doc.text(`Cliente: ${order.customerName}`, 20, y); y += 6;
                    doc.text(`M√©todo de Pago: ${order.method}`, 20, y); y += 6;
                    doc.text(`Vendedor: ${order.sellerId || 'Sistema'}`, 20, y); y += 12;
                    doc.autoTable({ startY: y, head: [['Producto', 'Cant.', 'Precio Unit.', 'Subtotal']], body: order.items.map(item => [item.name, item.quantity.toString(), formatMoney(item.price, config.currency), formatMoney(item.price * item.quantity, config.currency)]), theme: 'grid', headStyles: { fillColor: [16, 185, 129], textColor: 255, fontStyle: 'bold' }, columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 20, halign: 'center' }, 2: { cellWidth: 40, halign: 'right' }, 3: { cellWidth: 40, halign: 'right' } }, margin: { left: 20, right: 20 } });
                    y = doc.lastAutoTable.finalY + 10;
                    doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('TOTAL:', 130, y); doc.setTextColor(16, 185, 129); doc.text(formatMoney(order.total, config.currency), 190, y, { align: 'right' });
                    if (order.method === 'Credit') { y += 10; doc.setFontSize(10); doc.setTextColor(220, 38, 38); doc.setFont(undefined, 'bold'); doc.text('‚ö†Ô∏è VENTA A CR√âDITO - PENDIENTE DE PAGO', 105, y, { align: 'center' }); }
                    if (order.comment) { y += 10; doc.setFontSize(9); doc.setTextColor(100); doc.setFont(undefined, 'italic'); doc.text(`Nota: ${order.comment}`, 20, y); }
                    doc.setFontSize(8); doc.setTextColor(150); doc.setFont(undefined, 'normal');
                    doc.text('Gracias por su compra', 105, 280, { align: 'center' }); doc.text(`Generado por ${config.storeName}`, 105, 286, { align: 'center' });
                    const fileName = `Recibo_${order.customerName.replace(/\s/g, '_')}_${new Date().getTime()}.pdf`;
                    doc.save(fileName);
                    showCustomAlert('‚úÖ Recibo descargado exitosamente', 'success');
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    showCustomAlert('‚ùå Error al generar recibo', 'error');
                }
            };

            const POSView = () => {
                // Si estamos en vista global, mostramos advertencia
                if (currentLocation === 'all') {
                    return (
                        <div className="h-full flex items-center justify-center p-6 text-center">
                            <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl max-w-sm">
                                <div className="bg-orange-100 dark:bg-orange-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600 dark:text-orange-400">
                                    <MapPin size={40} />
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-2">Selecciona un Local</h3>
                                <p className="text-gray-500 dark:text-gray-400 mb-6">Para realizar ventas y descontar inventario correctamente, debes seleccionar una sucursal espec√≠fica en la barra superior.</p>
                                <div className="text-xs text-gray-400">Modo Global solo permite visualizaci√≥n</div>
                            </div>
                        </div>
                    );
                }

                // Estados del POS
                const [searchTerm, setSearchTerm] = useState("");
                const [selectedCat, setSelectedCat] = useState("Todas");
                const [customerSearch, setCustomerSearch] = useState("");
                const [selectedCustomer, setSelectedCustomer] = useState(null);
                const [showPayment, setShowPayment] = useState(false);
                const [mobileTab, setMobileTab] = useState('products');
                const [customDate, setCustomDate] = useState(getCurrentDateTimeLocal());
                const [cart, setCart] = useState([]);
                const [saleComment, setSaleComment] = useState("");
                const [digitalPayerName, setDigitalPayerName] = useState("");
                const [showConfirmation, setShowConfirmation] = useState(false);
                const [showReceipt, setShowReceipt] = useState(false);
                const [pendingMethod, setPendingMethod] = useState(null);
                const [lastOrder, setLastOrder] = useState(null);

                // Filtrado de Datos
                const localProducts = products.filter(checkLocation);
                const categories = ["Todas", ...new Set(localProducts.map(p => p.category))];

                const filteredProducts = localProducts.filter(p =>
                    (selectedCat === "Todas" || p.category === selectedCat) &&
                    p.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // Filtro de Clientes (Incluye bloqueados para poder verlos, pero avisa al cobrar)
                const localCustomers = customers.filter(checkLocation);
                const filteredCustomers = localCustomers.filter(c =>
                    c.name.toLowerCase().includes(customerSearch.toLowerCase()) ||
                    c.guardian?.toLowerCase().includes(customerSearch.toLowerCase())
                );

                // L√≥gica del Carrito
                const addToCart = (prod) => setCart(prev => {
                    const ex = prev.find(i => i.id === prod.id);
                    return ex ? prev.map(i => i.id === prod.id ? { ...i, qty: i.qty + 1 } : i) : [...prev, { ...prod, qty: 1 }];
                });

                // Funci√≥n para editar precio en el carrito
                const updateItemPrice = (id, newPrice) => {
                    setCart(prev => prev.map(item => item.id === id ? { ...item, price: parseFloat(newPrice) || 0 } : item));
                };

                const cartTotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
                const cartCount = cart.reduce((sum, i) => sum + i.qty, 0);

                // Funci√≥n para iniciar confirmaci√≥n de venta
                const startSale = (method) => {
                    // Validaci√≥n Yape/Plin
                    if ((method === 'Yape' || method === 'Plin') && !digitalPayerName.trim()) {
                        return showCustomAlert("‚ö†Ô∏è Por favor ingresa el nombre del pagador", 'warning');
                    }

                    // Validaci√≥n de cliente para cr√©dito
                    if (method === 'Credit') {
                        if (!selectedCustomer) return showCustomAlert("‚ö†Ô∏è Selecciona un cliente primero", 'warning');
                        if (selectedCustomer.blocked) return showCustomAlert("‚õî Cliente bloqueado por deuda", 'error');
                    }

                    // Validaci√≥n de Stock
                    const outOfStockItems = cart.filter(i => i.trackStock && i.qty > i.stock);
                    if (outOfStockItems.length > 0) {
                        const names = outOfStockItems.map(i => i.name).join(', ');
                        showCustomAlert(`‚ö†Ô∏è Stock insuficiente: ${names}`, 'warning', 5000);
                    }

                    setPendingMethod(method);
                    setShowPayment(false);
                    setShowConfirmation(true);
                };

                // Procesar Venta despu√©s de confirmaci√≥n
                const handleSale = async () => {
                    try {
                        const method = pendingMethod;
                        const saleDate = new Date(customDate).getTime();
                        const safeSellerId = user.id || user.uid || 'system_admin';
                        const order = {
                            items: cart.map(i => ({ name: i.name, quantity: i.qty, price: i.price, id: i.id })),
                            total: cartTotal,
                            date: saleDate,
                            customerId: selectedCustomer?.id || 'guest',
                            customerName: selectedCustomer?.name || 'Cliente Casual',
                            status: method === 'Delivery/Pedido' ? 'Pendiente' : 'Completado',
                            method,
                            sellerId: safeSellerId,
                            locationId: currentLocation,
                            comment: saleComment,
                            digitalPayerName: (method === 'Yape' || method === 'Plin') ? digitalPayerName : null,
                            sentToKitchen: false
                        };

                        // 1. Guardar la orden
                        await saveData('orders', order);

                        // 2. Descontar Stock
                        const { updateDoc, doc, increment } = window.firebaseModules;
                        cart.forEach(item => {
                            if (item.trackStock && item.id) {
                                const productRef = doc(db.current, 'artifacts', appId, 'public', 'data', 'products', item.id);
                                updateDoc(productRef, { stock: increment(-item.qty) }).catch(e => console.error(e));
                            }
                        });

                        // 3. Actualizar cr√©dito del cliente
                        let newDebt = undefined;
                        if (method === 'Credit' && selectedCustomer) {
                            newDebt = (selectedCustomer.credit || 0) + cartTotal;
                            await saveData('customers', { credit: newDebt }, selectedCustomer.id);
                        }

                        // Guardar orden para el recibo
                        setLastOrder({ ...order, newDebt });

                        // Mostrar comprobante
                        setShowConfirmation(false);
                        setShowReceipt(true);

                        // Resetear carrito
                        setCart([]);
                        setMobileTab('products');
                        setCustomDate(getCurrentDateTimeLocal());
                        setSaleComment("");
                        setDigitalPayerName("");
                    } catch (error) {
                        console.error('Error en venta:', error);
                        showCustomAlert('‚ùå Error al procesar la venta', 'error');
                    }
                };
                // Funci√≥n para detectar "Enter" del esc√°ner
                const handleScannerInput = (e) => {
                    if (e.key === 'Enter' && searchTerm.trim()) {
                        // 1. Buscamos coincidencia exacta (c√≥digo de barras o nombre completo)
                        const exactMatch = localProducts.find(p => p.name.toLowerCase() === searchTerm.toLowerCase());

                        if (exactMatch) {
                            addToCart(exactMatch);
                            setSearchTerm(""); // Limpiar para el siguiente escaneo
                        }
                        // 2. Si no es exacta, pero el filtro solo muestra UNO, asumimos que es ese
                        else if (filteredProducts.length === 1) {
                            addToCart(filteredProducts[0]);
                            setSearchTerm("");
                        }
                    }
                };

                return (
                    <div className="flex flex-col md:flex-row h-full relative overflow-hidden">

                        {/* COLUMNA IZQUIERDA: PRODUCTOS */}
                        <div className={`flex-1 flex flex-col h-full overflow-hidden ${mobileTab === 'cart' ? 'hidden md:flex' : 'flex'}`}>
                            <div className="flex flex-col gap-3 p-4 md:p-6 pb-2 flex-shrink-0">
                                {/* Categor√≠as */}
                                <div className="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                                    {categories.map(cat => (
                                        <button key={cat} onClick={() => setSelectedCat(cat)} className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium border transition-colors ${selectedCat === cat ? 'bg-emerald-600 text-white border-emerald-600 shadow-sm' : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-slate-600'}`}>{cat}</button>
                                    ))}
                                </div>
                                {/* Buscador de Productos */}
                                <div className="relative">
                                    <Search className="absolute left-3 top-2.5 text-gray-400" size={20} />
                                    <input
                                        type="text"
                                        placeholder="Buscar producto o escanear..."
                                        className="w-full pl-10 pr-4 py-2 rounded-xl border-none shadow-sm bg-white dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-emerald-500 outline-none text-sm"
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        onKeyDown={handleScannerInput} // <--- NUEVO: Detecta el Enter del esc√°ner
                                        autoFocus // <--- NUEVO: Pone el cursor ah√≠ al entrar
                                    />
                                </div>
                            </div>

                            {/* Grid de Productos */}
                            <div className="scroll-view p-4 md:p-6 pt-0 pb-32 md:pb-6">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start">
                                    {filteredProducts.map(prod => (
                                        <div key={prod.id} onClick={() => addToCart(prod)} className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm cursor-pointer overflow-hidden border-b-4 ${CATEGORY_COLORS[prod.category] || CATEGORY_COLORS['default']} hover:shadow-md transition active:scale-95 duration-100 relative`}>
                                            {/* Indicador visual de stock bajo */}
                                            {prod.trackStock && prod.stock < 5 && <div className="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full animate-pulse border border-white"></div>}

                                            <div className="h-24 md:h-32 bg-gray-50 dark:bg-slate-700 w-full overflow-hidden relative">
                                                {prod.image ? <img src={prod.image} className="w-full h-full object-cover" /> : (ImageIcon && <ImageIcon className="absolute inset-0 m-auto text-gray-300 dark:text-gray-600" size={32} />)}
                                            </div>
                                            <div className="p-2 md:p-3">
                                                <p className="font-semibold text-gray-800 dark:text-gray-200 text-xs md:text-sm line-clamp-2 h-8 md:h-9">{prod.name}</p>
                                                <div className="mt-1 font-bold text-emerald-700 dark:text-emerald-400 text-base md:text-lg">{formatMoney(prod.price, config.currency)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* COLUMNA DERECHA: CARRITO Y CLIENTE */}
                        <div className={`w-full md:w-96 bg-white dark:bg-slate-800 flex flex-col h-full border-l border-emerald-100 dark:border-slate-700 ${mobileTab === 'products' ? 'hidden md:flex' : 'flex'}`}>

                            {/* Cabecera Carrito */}
                            <div className="p-4 bg-emerald-50 dark:bg-slate-900 rounded-tl-xl flex justify-between items-center border-b border-emerald-100 dark:border-slate-700">
                                <h3 className="font-bold text-emerald-800 dark:text-emerald-200 flex gap-2">{ShoppingCart && <ShoppingCart size={20} />} Orden Actual</h3>
                                <button onClick={() => setCart([])} className="text-red-500 text-xs font-bold hover:bg-red-50 dark:hover:bg-red-900/30 px-2 py-1 rounded">Limpiar</button>
                            </div>

                            {/* Buscador de Clientes */}
                            <div className="p-3 border-b border-emerald-100 dark:border-slate-700 relative bg-white dark:bg-slate-800 z-10">
                                {selectedCustomer ? (
                                    <div className={`flex justify-between items-center p-2 rounded-lg ${selectedCustomer.blocked ? 'bg-red-100 border-red-300' : (selectedCustomer.credit > 0 ? 'bg-red-50 border-red-200' : 'bg-emerald-50 border-emerald-200')} border`}>
                                        <div>
                                            <p className={`text-sm font-bold ${selectedCustomer.blocked ? 'text-red-900' : 'text-gray-800'} dark:text-black`}>
                                                {selectedCustomer.name} {selectedCustomer.blocked && '(BLOQUEADO)'}
                                            </p>
                                            <p className="text-xs text-gray-600">Deuda: {formatMoney(selectedCustomer.credit, config.currency)}</p>
                                        </div>
                                        <button onClick={() => setSelectedCustomer(null)}>{X && <X size={16} className="text-gray-500" />}</button>
                                    </div>
                                ) : (
                                    <div className="relative">
                                        <input className="w-full text-sm p-2 border dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-700 dark:text-white" placeholder="Buscar Cliente..." value={customerSearch} onChange={e => setCustomerSearch(e.target.value)} />
                                        {customerSearch && (
                                            <div className="absolute top-full w-full bg-white dark:bg-slate-800 shadow-xl border dark:border-slate-600 rounded-lg mt-1 z-20 max-h-40 overflow-y-auto">
                                                {filteredCustomers.map(c => (
                                                    <div key={c.id} className="p-2 hover:bg-emerald-50 dark:hover:bg-slate-700 cursor-pointer text-sm border-b dark:border-slate-700 flex justify-between items-center" onClick={() => { setSelectedCustomer(c); setCustomerSearch(""); }}>
                                                        <div>
                                                            <div className="font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                                                                {c.name} {c.blocked && <span className="text-[10px] text-red-600 bg-red-100 px-1 rounded border border-red-200">‚õî</span>}
                                                            </div>
                                                            <div className="text-xs text-gray-500">{c.type}</div>
                                                        </div>
                                                        {c.credit > 0 && <span className="text-xs font-bold text-red-500">{formatMoney(c.credit, config.currency)}</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Lista de Items */}
                            <div className="scroll-view p-3 space-y-2 pb-32 md:pb-3">
                                {cart.map(item => (
                                    <div key={item.id} className="flex justify-between items-center text-sm p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded border border-transparent hover:border-gray-200 dark:hover:border-slate-600">
                                        <div className="flex-1">
                                            <p className="font-medium text-gray-800 dark:text-gray-200">{item.name}</p>
                                            {/* PRECIO EDITABLE */}
                                            <input type="number" className="text-xs text-gray-500 w-16 bg-transparent border-b border-gray-300 outline-none focus:border-emerald-500"
                                                value={item.price} onClick={(e) => e.stopPropagation()} onChange={(e) => updateItemPrice(item.id, e.target.value)} />
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => setCart(prev => prev.map(i => i.id === item.id ? { ...i, qty: Math.max(0, i.qty - 1) } : i).filter(i => i.qty > 0))} className="p-1 bg-gray-100 dark:bg-slate-700 rounded text-gray-600 dark:text-gray-300">{Minus && <Minus size={14} />}</button>
                                            <span className="w-4 text-center font-bold text-gray-800 dark:text-white">{item.qty}</span>
                                            <button onClick={() => setCart(prev => prev.map(i => i.id === item.id ? { ...i, qty: i.qty + 1 } : i))} className="p-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 rounded">{Plus && <Plus size={14} />}</button>
                                        </div>
                                        <div className="w-16 text-right font-bold text-gray-700 dark:text-gray-300">{formatMoney(item.price * item.qty, config.currency)}</div>
                                    </div>
                                ))}
                            </div>

                            {/* Bot√≥n Pagar */}
                            <div className="hidden md:block p-4 bg-emerald-900 dark:bg-slate-900 text-white">
                                <div className="flex justify-between items-center mb-4"><span>Total</span><span className="text-2xl font-bold">{formatMoney(cartTotal, config.currency)}</span></div>
                                <button disabled={cart.length === 0} onClick={() => setShowPayment(true)} className="w-full bg-emerald-500 hover:bg-emerald-600 disabled:bg-gray-700 py-3 rounded-lg font-bold shadow-lg transition flex justify-center items-center gap-2">Pagar {ChevronRight && <ChevronRight size={18} />}</button>
                            </div>
                        </div>

                        {/* BARRA M√ìVIL */}
                        <div className="md:hidden fixed bottom-4 left-4 right-4 bg-white dark:bg-slate-800 rounded-full shadow-2xl border border-gray-100 dark:border-slate-700 p-1 flex z-40">
                            <button onClick={() => setMobileTab('products')} className={`flex-1 py-3 rounded-full text-sm font-bold flex justify-center items-center gap-2 transition-all ${mobileTab === 'products' ? 'bg-emerald-600 text-white shadow-md' : 'text-gray-500 dark:text-gray-400'}`}>{Package && <Package size={18} />} Productos</button>
                            <button onClick={() => setMobileTab('cart')} className={`flex-1 py-3 rounded-full text-sm font-bold flex justify-center items-center gap-2 transition-all ${mobileTab === 'cart' ? 'bg-emerald-600 text-white shadow-md' : 'text-gray-500 dark:text-gray-400'}`}>{ShoppingCart && <ShoppingCart size={18} />} Carrito ({cartCount})</button>
                        </div>
                        {mobileTab === 'cart' && (<div className="md:hidden fixed bottom-20 left-4 right-4 z-40"><div className="bg-emerald-900 dark:bg-slate-900 text-white p-4 rounded-xl shadow-lg"><div className="flex justify-between items-center mb-2"><span>Total</span><span className="text-xl font-bold">{formatMoney(cartTotal, config.currency)}</span></div><button disabled={cart.length === 0} onClick={() => setShowPayment(true)} className="w-full bg-emerald-500 py-3 rounded-lg font-bold">Pagar Ahora</button></div></div>)}

                        {/* MODAL DE PAGO */}
                        {showPayment && (
                            <div className="fixed inset-0 bg-black/80 z-[60] flex items-end md:items-center justify-center p-0 md:p-4">
                                <div className="bg-white dark:bg-slate-800 rounded-t-3xl md:rounded-2xl w-full max-w-md p-6 slide-up">
                                    <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-gray-800 dark:text-white">Confirmar Pago</h3><button onClick={() => setShowPayment(false)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full dark:text-white">{X && <X size={20} />}</button></div>

                                    <div className="mb-4 bg-gray-50 dark:bg-slate-700 p-2 rounded-lg flex flex-col gap-2 border border-gray-200 dark:border-slate-600">
                                        <div className="flex justify-between items-center"><label className="text-sm font-bold text-gray-600 dark:text-gray-300">Fecha:</label><input type="datetime-local" className="bg-transparent text-sm outline-none font-medium dark:text-white" value={customDate} onChange={e => setCustomDate(e.target.value)} /></div>
                                        <input className="w-full p-2 text-sm border-t dark:border-slate-600 bg-transparent outline-none dark:text-white" placeholder="A√±adir nota o comentario..." value={saleComment} onChange={e => setSaleComment(e.target.value)} />
                                        <input className="w-full p-2 text-sm border-t dark:border-slate-600 bg-transparent outline-none dark:text-white" placeholder="Nombre titular Yape/Plin (Si aplica)" value={digitalPayerName} onChange={e => setDigitalPayerName(e.target.value)} />
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-6">
                                        {['Efectivo', 'Tarjeta', 'Yape', 'Plin', 'Credit', 'Delivery/Pedido'].map(m => (
                                            <button
                                                key={m}
                                                onClick={() => startSale(m)}
                                                className={`p-4 border dark:border-slate-600 rounded-xl font-bold flex flex-col items-center gap-2 transition 
                                                ${m === 'Credit' && !selectedCustomer ? 'opacity-50 cursor-not-allowed bg-gray-100 dark:bg-slate-700' : 'hover:bg-emerald-50 dark:hover:bg-slate-600 hover:border-emerald-500'} 
                                                dark:text-gray-200`}
                                            >
                                                {m === 'Credit' ? 'Cr√©dito' : m}
                                            </button>
                                        ))}
                                    </div>

                                    {qrs.length > 0 && (<div className="mb-4"><p className="text-xs font-bold text-gray-500 uppercase mb-2">QRs Disponibles</p><div className="flex gap-2 overflow-x-auto pb-2">{qrs.map(qr => (<div key={qr.id} className="w-24 h-24 flex-shrink-0 border dark:border-slate-600 rounded-lg p-1 bg-white dark:bg-slate-700 shadow-sm flex flex-col items-center justify-center"><img src={qr.image} className="w-full h-full object-contain" /></div>))}</div></div>)}
                                    <button onClick={() => setShowPayment(false)} className="w-full py-3 text-gray-500 dark:text-gray-300 font-bold bg-gray-100 dark:bg-slate-700 rounded-xl">Cancelar</button>
                                </div>
                            </div>
                        )}

                        {/* MODAL DE CONFIRMACI√ìN */}
                        {showConfirmation && (
                            <SaleConfirmation
                                cart={cart}
                                customer={selectedCustomer}
                                total={cartTotal}
                                method={pendingMethod}
                                currency={config.currency}
                                onConfirm={handleSale}
                                onCancel={() => {
                                    setShowConfirmation(false);
                                    setShowPayment(true);
                                }}
                            />
                        )}

                        {/* MODAL DE COMPROBANTE */}
                        {showReceipt && lastOrder && (
                            <SaleReceipt
                                customer={{ name: lastOrder.customerName }}
                                total={lastOrder.total}
                                method={lastOrder.method}
                                newDebt={lastOrder.newDebt}
                                currency={config.currency}
                                onClose={() => {
                                    setShowReceipt(false);
                                    setSelectedCustomer(null);
                                }}
                                onPrintReceipt={() => generateReceiptPDF(lastOrder, config)}
                            />
                        )}
                    </div>
                );
            };
            const QRsView = () => {
                const [form, setForm] = useState({ name: '', type: 'Yape', image: null });
                const [previewQR, setPreviewQR] = useState(null);
                const handleImage = async (e) => { if (e.target.files[0]) setForm({ ...form, image: await compressImage(e.target.files[0], 200) }); };
                const handleAdd = async () => { if (!form.image) return alert("Sube una imagen"); await saveData('qrs', form); setForm({ name: '', type: 'Yape', image: null }); };
                return (<div className="scroll-view"><div className="p-4 md:p-6 pb-32 space-y-6"><h2 className="text-2xl font-bold text-emerald-900 dark:text-emerald-100">Gesti√≥n de QRs</h2><div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-emerald-100 dark:border-slate-700"><h3 className="font-bold mb-3 dark:text-white">Agregar Nuevo QR</h3><div className="grid gap-3"><input placeholder="Nombre (ej. Yape Tienda)" className="p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} /><select className="p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.type} onChange={e => setForm({ ...form, type: e.target.value })}><option value="Yape">Yape</option><option value="Plin">Plin</option><option value="Otro">Otro</option></select><div className="border-2 border-dashed dark:border-slate-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 relative">{form.image ? <img src={form.image} className="h-20 mx-auto object-contain" /> : <span className="text-gray-400 text-sm">Subir Imagen QR</span>}<input type="file" className="absolute inset-0 opacity-0" onChange={handleImage} /></div><button onClick={handleAdd} className="bg-emerald-600 text-white py-2 rounded font-bold">Guardar QR</button></div></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{qrs.map(qr => (<div key={qr.id} className="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border dark:border-slate-700 relative group cursor-pointer hover:shadow-md transition" onClick={() => setPreviewQR(qr)}><img src={qr.image} className="w-full aspect-square object-contain mb-2 bg-gray-50 dark:bg-slate-700 rounded" /><p className="font-bold text-center text-sm dark:text-white">{qr.name}</p><p className="text-center text-xs text-gray-500">{qr.type}</p><button onClick={(e) => { e.stopPropagation(); deleteData('qrs', qr.id); }} className="absolute top-2 right-2 bg-red-100 text-red-600 p-1 rounded-full">{X && <X size={14} />}</button></div>))}</div>{previewQR && (<div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" onClick={() => setPreviewQR(null)}><div className="bg-white dark:bg-slate-800 p-2 rounded-2xl max-w-sm w-full relative animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}><button onClick={() => setPreviewQR(null)} className="absolute -top-12 right-0 text-white bg-white/20 p-2 rounded-full hover:bg-white/30 backdrop-blur-md">{X && <X size={24} />}</button><div className="bg-white dark:bg-slate-800 p-4 rounded-xl"><h3 className="text-xl font-bold text-center mb-4 text-emerald-900 dark:text-white">{previewQR.name}</h3><div className="bg-gray-50 dark:bg-slate-700 p-2 rounded-xl border-2 border-dashed border-emerald-100 dark:border-slate-600 mb-2"><img src={previewQR.image} className="w-full h-auto object-contain rounded-lg" /></div><p className="text-center text-emerald-600 dark:text-emerald-400 font-medium bg-emerald-50 dark:bg-slate-900 py-1 rounded-lg text-sm">{previewQR.type}</p></div></div></div>)}</div></div>);
            };

            const ExpenseView = () => {
                const [expenses, setExpenses] = useState([]);
                const [form, setForm] = useState({
                    description: '',
                    amount: '',
                    category: 'Proveedores',
                    date: getCurrentDateTimeLocal()
                });

                const categories = ["Proveedores", "Servicios (Luz/Agua)", "Personal/Sueldos", "Alquiler", "Mantenimiento", "Otros"];

                // Cargar gastos
                useEffect(() => {
                    try {
                        const { collection, onSnapshot, query, orderBy, limit } = window.firebaseModules;
                        const q = query(
                            collection(db.current, 'artifacts', appId, 'public', 'data', 'expenses'),
                            orderBy('date', 'desc'),
                            limit(100)
                        );
                        const unsub = onSnapshot(q, (snap) => {
                            const list = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(checkLocation);
                            setExpenses(list);
                        });
                        return () => unsub();
                    } catch (error) {
                        console.error("Error cargando gastos:", error);
                    }
                }, [currentLocation]);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!form.description || !form.amount) {
                        alert("Por favor completa todos los campos");
                        return;
                    }

                    try {
                        await saveData('expenses', {
                            description: form.description,
                            amount: parseFloat(form.amount),
                            category: form.category,
                            date: new Date(form.date).getTime(),
                            locationId: currentLocation,
                            userId: user?.uid || user?.id || 'unknown'
                        });
                        setForm({ ...form, description: '', amount: '' });
                    } catch (error) {
                        console.error("Error guardando gasto:", error);
                        alert("Error al guardar el gasto");
                    }
                };

                const deleteExpense = async (id) => {
                    if (confirm("¬øBorrar este gasto?")) {
                        try {
                            await deleteData('expenses', id);
                        } catch (error) {
                            console.error("Error eliminando gasto:", error);
                        }
                    }
                };

                const totalExpenses = expenses.reduce((sum, item) => sum + (item.amount || 0), 0);

                return (
                    <div className="h-full w-full flex flex-col md:flex-row bg-gray-50 dark:bg-slate-900">
                        {/* FORMULARIO IZQUIERDA */}
                        <div className="w-full md:w-96 p-6 bg-white dark:bg-slate-800 border-r border-gray-200 dark:border-slate-700 overflow-y-auto shrink-0">
                            <h2 className="text-2xl font-bold text-red-600 dark:text-red-400 mb-6 flex items-center gap-2">
                                {TrendingDown && <TrendingDown size={28} />}
                                <span>Registrar Gasto</span>
                            </h2>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">
                                        Descripci√≥n
                                    </label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-red-500"
                                        placeholder="Ej: Pago de Luz"
                                        value={form.description}
                                        onChange={e => setForm({ ...form, description: e.target.value })}
                                        required
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">
                                            Monto
                                        </label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            className="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-red-600 dark:text-red-400 font-bold outline-none focus:ring-2 focus:ring-red-500"
                                            placeholder="0.00"
                                            value={form.amount}
                                            onChange={e => setForm({ ...form, amount: e.target.value })}
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">
                                            Categor√≠a
                                        </label>
                                        <select
                                            className="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-red-500"
                                            value={form.category}
                                            onChange={e => setForm({ ...form, category: e.target.value })}
                                        >
                                            {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">
                                        Fecha del Gasto
                                    </label>
                                    <input
                                        type="datetime-local"
                                        className="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-700 text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-red-500"
                                        value={form.date}
                                        onChange={e => setForm({ ...form, date: e.target.value })}
                                    />
                                </div>

                                <button
                                    type="submit"
                                    className="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2"
                                >
                                    {Save && <Save size={20} />}
                                    <span>Guardar Gasto</span>
                                </button>
                            </form>

                            <div className="mt-8 p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-900">
                                <p className="text-sm text-red-800 dark:text-red-300 font-bold uppercase mb-1">
                                    Total Gastado
                                </p>
                                <p className="text-3xl font-bold text-red-600 dark:text-red-400">
                                    {formatMoney(totalExpenses, config.currency)}
                                </p>
                            </div>
                        </div>

                        {/* LISTA DERECHA */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            <h3 className="font-bold text-xl mb-4 text-gray-800 dark:text-white">
                                √öltimos Movimientos
                            </h3>

                            {expenses.length === 0 ? (
                                <div className="text-center py-20">
                                    <p className="text-gray-400 text-lg">No hay gastos registrados</p>
                                    <p className="text-gray-400 text-sm mt-2">Los gastos aparecer√°n aqu√≠ una vez registrados</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {expenses.map(item => (
                                        <div
                                            key={item.id}
                                            className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 border-l-red-500 border border-gray-200 dark:border-slate-700 flex justify-between items-center group hover:shadow-md transition"
                                        >
                                            <div className="flex-1 min-w-0">
                                                <p className="font-bold text-gray-800 dark:text-white text-lg truncate">
                                                    {item.description}
                                                </p>
                                                <div className="flex flex-wrap gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    <span className="bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded">
                                                        {item.category}
                                                    </span>
                                                    <span>
                                                        {new Date(item.date).toLocaleDateString()} {new Date(item.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="text-right ml-4 shrink-0">
                                                <p className="font-bold text-red-600 dark:text-red-400 text-lg whitespace-nowrap">
                                                    -{formatMoney(item.amount, config.currency)}
                                                </p>
                                                <button
                                                    onClick={() => deleteExpense(item.id)}
                                                    className="text-xs text-red-400 hover:text-red-600 dark:hover:text-red-300 underline opacity-0 group-hover:opacity-100 transition"
                                                >
                                                    Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };
            const KitchenView = () => {
                // Filtramos solo los pedidos pendientes de este local QUE HAYAN SIDO ENVIADOS A COCINA
                const pendingOrders = orders.filter(o =>
                    checkLocation(o) &&
                    (o.status === 'Pendiente' || o.status === 'En Proceso' || o.status === 'Comanda') &&
                    o.sentToKitchen === true
                ).sort((a, b) => a.date - b.date); // Los m√°s antiguos primero

                // Debug: Ver qu√© √≥rdenes hay
                console.log('üç≥ COCINA - Total √≥rdenes:', orders.length);
                console.log('üç≥ COCINA - √ìrdenes filtradas:', pendingOrders.length);
                console.log('üç≥ COCINA - Estados de todas las √≥rdenes:', orders.map(o => ({
                    id: o.id?.slice(-4),
                    status: o.status,
                    sentToKitchen: o.sentToKitchen,
                    customer: o.customerName
                })));

                const advanceStatus = async (order) => {
                    let nextStatus = 'Completado';
                    if (order.status === 'Pendiente') nextStatus = 'En Proceso';

                    // Si ya se va a completar, preguntamos
                    if (nextStatus === 'Completado') {
                        if (!confirm("¬øPedido Listo? Se mover√° al historial.")) return;
                    }

                    await saveData('orders', { status: nextStatus }, order.id);
                };

                return (
                    <div className="scroll-view bg-gray-100 dark:bg-slate-900 min-h-full p-4">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                                {Utensils && <Utensils size={32} />} Pantalla de Cocina
                            </h2>
                            <span className="bg-orange-500 text-white px-4 py-2 rounded-full font-bold shadow-lg animate-pulse">
                                {pendingOrders.length} Pedidos Pendientes
                            </span>
                        </div>

                        {pendingOrders.length === 0 && (
                            <div className="flex flex-col items-center justify-center h-96 text-gray-400">
                                <CheckCircle2 size={64} className="mb-4 text-emerald-200" />
                                <p className="text-xl">Todo tranquilo por ahora...</p>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {pendingOrders.map(order => {
                                // Calcular tiempo transcurrido
                                const minutes = Math.floor((Date.now() - order.date) / 60000);
                                const isLate = minutes > 15; // Alerta si pasa de 15 min

                                return (
                                    <div key={order.id} className={`bg-white dark:bg-slate-800 rounded-xl shadow-md border-l-8 overflow-hidden flex flex-col ${isLate ? 'border-red-500' : 'border-emerald-500'}`}>
                                        {/* Cabecera del Ticket */}
                                        <div className="p-3 border-b dark:border-slate-700 bg-gray-50 dark:bg-slate-700 flex justify-between items-start">
                                            <div>
                                                <h3 className="font-bold text-lg dark:text-white">#{order.id.slice(-4)}</h3>
                                                <p className="text-xs text-gray-500 dark:text-gray-400">{order.customerName}</p>
                                            </div>
                                            <div className="text-right">
                                                <span className="text-xs font-bold bg-white dark:bg-slate-600 px-2 py-1 rounded border shadow-sm">
                                                    {new Date(order.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                </span>
                                                <p className={`text-xs font-bold mt-1 ${isLate ? 'text-red-500' : 'text-emerald-600'}`}>
                                                    Hace {minutes} min
                                                </p>
                                            </div>
                                        </div>

                                        {/* Lista de Platos */}
                                        <div className="p-4 flex-1 overflow-y-auto max-h-60">
                                            {order.items.map((item, idx) => (
                                                <div key={idx} className="mb-3 border-b border-dashed border-gray-200 last:border-0 pb-2 last:pb-0">
                                                    <div className="flex gap-2">
                                                        <span className="font-bold text-xl text-gray-800 dark:text-white w-8">{item.quantity}</span>
                                                        <div className="flex-1">
                                                            <span className="font-bold text-gray-700 dark:text-gray-200 text-lg leading-tight block">{item.name}</span>
                                                            {/* Detectamos observaciones en el nombre o campo obs */}
                                                            {(item.name.includes('(') || item.obs) && (
                                                                <p className="text-red-500 font-bold text-sm mt-1 bg-red-50 p-1 rounded inline-block">
                                                                    ‚ö†Ô∏è {item.obs || 'Ver observaci√≥n'}
                                                                </p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {order.comment && (
                                                <div className="mt-2 bg-yellow-50 p-2 rounded border border-yellow-200 text-sm text-yellow-800 font-bold">
                                                    Nota: {order.comment}
                                                </div>
                                            )}
                                        </div>

                                        {/* Bot√≥n de Acci√≥n */}
                                        <button
                                            onClick={() => advanceStatus(order)}
                                            className={`w-full py-4 font-bold text-white text-lg transition hover:brightness-110 active:scale-95 flex justify-center items-center gap-2
                                            ${order.status === 'Pendiente' ? 'bg-orange-500' : 'bg-emerald-600'}`}
                                        >
                                            {order.status === 'Pendiente' ? 'üë®‚Äçüç≥ Empezar a Cocinar' : '‚úÖ ¬°Pedido Listo!'}
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };
            const DigitalVerificationView = () => {
                const appMode = getCurrentMode();
                const filteredTransactions = orders.filter(o =>
                    checkLocation(o) &&
                    (o.method === 'Yape' || o.method === 'Plin' || o.method === 'Transferencia')
                ).sort((a, b) => b.date - a.date);

                const confirmDelivery = async (order) => {
                    const saveVerificationComment = async (id, comment) => {
                        await saveData('orders', { verificationComment: comment }, id);
                    };
                    if (confirm("¬øConfirmar entrega del pedido?")) {
                        await saveData('orders', { deliveryTime: Date.now() }, order.id);
                    }
                };

                return (
                    <div className="scroll-view">
                        <div className="p-4 md:p-6 pb-32 space-y-6">
                            <h2 className="text-2xl font-bold text-purple-700 dark:text-purple-400 flex items-center gap-2">
                                {CheckSquare && <CheckSquare />} Verificaci√≥n Digital
                            </h2>
                            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-purple-50 dark:bg-slate-700 text-purple-900 dark:text-purple-100 sticky top-0 uppercase text-xs">
                                            <tr>
                                                <th className="p-3">Fecha/Hora</th>
                                                <th className="p-3">Titular (Pago)</th>
                                                {appMode === 'kiosk' && <th className="p-3">Alumno</th>}
                                                <th className="p-3 text-right">Monto</th>
                                                <th className="p-3">Observaciones</th>
                                                <th className="p-3 text-center">Entrega</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredTransactions.map(o => (
                                                <tr key={o.id} className="border-b dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700">
                                                    <td className="p-3">
                                                        <div className="font-bold dark:text-white">{new Date(o.date).toLocaleDateString()}</div>
                                                        <div className="text-xs text-gray-500">{new Date(o.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                                    </td>
                                                    <td className="p-3">
                                                        <div className="font-bold text-gray-800 dark:text-gray-200">{o.digitalPayerName || 'No registrado'}</div>
                                                        <span className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">{o.method}</span>
                                                    </td>
                                                    {appMode === 'kiosk' && (
                                                        <td className="p-3 text-gray-700 dark:text-gray-300">
                                                            {o.customerName}
                                                        </td>
                                                    )}
                                                    <td className="p-3 text-right font-bold text-emerald-600">{formatMoney(o.total, config.currency)}</td>
                                                    <td className="p-3">
                                                        <input
                                                            className="w-full bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded px-2 py-1 text-xs outline-none focus:border-purple-500 dark:text-white"
                                                            placeholder="Nota..."
                                                            defaultValue={o.verificationComment || ''}
                                                            onBlur={(e) => saveVerificationComment(o.id, e.target.value)}
                                                        />
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        {o.deliveryTime ? (
                                                            <div className="text-green-600 flex flex-col items-center">
                                                                <span className="text-xs font-bold">Entregado</span>
                                                                <span className="text-[10px]">{new Date(o.deliveryTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => confirmDelivery(o)} className="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-purple-700">Confirmar</button>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const InventoryView = ({ orders }) => {
                const [isEditing, setIsEditing] = useState(false);
                const [form, setForm] = useState({ name: '', price: '', category: 'General', image: null, trackStock: false, stock: 0 });
                const [stats, setStats] = useState({ best: null, worst: null, totalValue: 0 });

                const filteredProducts = products.filter(checkLocation);
                const categories = [...new Set([...Object.keys(CATEGORY_COLORS).filter(c => c !== 'default'), ...filteredProducts.map(p => p.category)])];

                // --- INTELIGENCIA DE NEGOCIO ---
                useEffect(() => {
                    if (!orders || orders.length === 0) return;

                    // 1. Calcular frecuencia de ventas por producto
                    const salesCount = {};
                    orders.forEach(order => {
                        if (order.status !== 'Anulado') {
                            order.items.forEach(item => {
                                // Usamos el nombre como clave simple, idealmente ser√≠a ID
                                salesCount[item.name] = (salesCount[item.name] || 0) + item.quantity;
                            });
                        }
                    });

                    // 2. Encontrar mejor y peor
                    let max = -1, min = Infinity;
                    let bestProd = null, worstProd = null;

                    // Solo analizamos productos que existen actualmente
                    filteredProducts.forEach(p => {
                        const count = salesCount[p.name] || 0; // Si no hay ventas, es 0
                        if (count > max) { max = count; bestProd = { name: p.name, count }; }
                        if (count < min) { min = count; worstProd = { name: p.name, count }; }
                    });

                    // 3. Valorizaci√≥n de Stock
                    const totalVal = filteredProducts.reduce((acc, p) => {
                        return acc + (p.trackStock ? (p.price * p.stock) : 0);
                    }, 0);

                    setStats({ best: bestProd, worst: worstProd, totalValue: totalVal });

                }, [orders, products, currentLocation]);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    let locId = form.locationId;
                    if (!locId) locId = currentLocation === 'all' ? 'main' : currentLocation;

                    await saveData('products', {
                        ...form,
                        price: parseFloat(form.price),
                        stock: form.trackStock ? parseInt(form.stock) : 0, // Guardar stock solo si se activa
                        locationId: locId
                    }, form.id);

                    setIsEditing(false);
                    setForm({ name: '', price: '', category: 'General', image: null, trackStock: false, stock: 0 });
                };

                const handleImage = async (e) => { if (e.target.files[0]) setForm({ ...form, image: await compressImage(e.target.files[0], 200) }); };

                return (
                    <div className="scroll-view">
                        <div className="p-4 md:p-6 pb-32 space-y-6">

                            {/* PANEL DE INTELIGENCIA */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-4 rounded-xl shadow-lg relative overflow-hidden">
                                    <p className="text-xs font-bold opacity-80 uppercase">Producto Estrella üåü</p>
                                    <h3 className="text-xl font-bold mt-1 truncate">{stats.best ? stats.best.name : '-'}</h3>
                                    <p className="text-sm opacity-90">{stats.best ? `${stats.best.count} vendidos` : 'Sin datos'}</p>
                                    <TrendingUp className="absolute right-2 bottom-2 opacity-20" size={60} />
                                </div>
                                <div className="bg-white dark:bg-slate-800 border-l-4 border-orange-400 p-4 rounded-xl shadow-sm relative">
                                    <p className="text-xs font-bold text-gray-500 uppercase">Menor Rotaci√≥n üê¢</p>
                                    <h3 className="text-lg font-bold mt-1 dark:text-white truncate">{stats.worst ? stats.worst.name : '-'}</h3>
                                    <p className="text-xs text-gray-400">{stats.worst ? `${stats.worst.count} vendidos` : '-'}</p>
                                </div>
                                <div className="bg-white dark:bg-slate-800 border-l-4 border-blue-500 p-4 rounded-xl shadow-sm relative">
                                    <p className="text-xs font-bold text-gray-500 uppercase">Valor en Almac√©n üí∞</p>
                                    <h3 className="text-2xl font-bold mt-1 text-emerald-600 dark:text-emerald-400">{formatMoney(stats.totalValue, config.currency)}</h3>
                                </div>
                            </div>

                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-emerald-900 dark:text-emerald-100">Inventario</h2>
                                <button onClick={() => { setIsEditing(true); setForm({ category: 'General', name: '', price: '', trackStock: false, stock: 0 }); }} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2">{Plus && <Plus size={18} />} Nuevo</button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filteredProducts.map(p => (
                                    <div key={p.id} className="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border dark:border-slate-700 flex items-center gap-3 relative overflow-hidden">
                                        {/* Barra lateral de estado de stock */}
                                        {p.trackStock && (
                                            <div className={`absolute left-0 top-0 bottom-0 w-1 ${p.stock < 5 ? 'bg-red-500' : 'bg-emerald-500'}`}></div>
                                        )}

                                        <div className="w-12 h-12 bg-gray-100 dark:bg-slate-700 rounded-lg overflow-hidden shrink-0">
                                            {p.image ? <img src={p.image} className="w-full h-full object-cover" /> : (Package && <Package size={20} className="m-3 text-gray-400" />)}
                                        </div>
                                        <div className="flex-1 overflow-hidden pl-2">
                                            <p className="font-bold text-gray-800 dark:text-gray-200 truncate">{p.name}</p>
                                            <div className="flex gap-2 mt-1">
                                                <span className="text-[10px] bg-gray-100 dark:bg-slate-700 dark:text-gray-300 px-2 py-0.5 rounded-full">{p.category}</span>
                                                {p.trackStock ? (
                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold border ${p.stock < 5 ? 'text-red-600 border-red-200 bg-red-50' : 'text-emerald-600 border-emerald-200 bg-emerald-50'}`}>
                                                        Stock: {p.stock}
                                                    </span>
                                                ) : (
                                                    <span className="text-[10px] px-2 py-0.5 rounded-full font-bold text-blue-600 border border-blue-200 bg-blue-50">‚àû Infinito</span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-emerald-700 dark:text-emerald-400">{formatMoney(p.price, config.currency)}</div>
                                            <div className="flex gap-1 mt-1 justify-end">
                                                <button onClick={() => { setForm(p); setIsEditing(true); }} className="p-1.5 text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg"><FileText size={14} /></button>
                                                <button onClick={() => deleteData('products', p.id)} className="p-1.5 text-red-600 bg-red-50 dark:bg-red-900/30 rounded-lg"><Trash2 size={14} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {isEditing && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-lg p-6">
                                        <h3 className="text-xl font-bold mb-4 dark:text-white">{form.id ? 'Editar' : 'Nuevo'} Producto</h3>
                                        <form onSubmit={handleSubmit} className="space-y-4">
                                            <input required className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Nombre" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} />

                                            <div className="grid grid-cols-2 gap-4">
                                                <input required type="number" step="0.01" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Precio" value={form.price} onChange={e => setForm({ ...form, price: e.target.value })} />
                                                <div>
                                                    <input list="cat-options" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Categor√≠a" value={form.category} onChange={e => setForm({ ...form, category: e.target.value })} />
                                                    <datalist id="cat-options">{categories.map(c => <option key={c} value={c} />)}</datalist>
                                                </div>
                                            </div>

                                            {/* SECCI√ìN DE CONTROL DE STOCK */}
                                            <div className="p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600">
                                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                    <input type="checkbox" className="w-5 h-5 accent-emerald-600" checked={form.trackStock} onChange={e => setForm({ ...form, trackStock: e.target.checked })} />
                                                    <span className="font-bold text-sm dark:text-white">Controlar Stock</span>
                                                </label>

                                                {form.trackStock && (
                                                    <div className="animate-in fade-in slide-in-from-top-2">
                                                        <label className="text-xs font-bold text-gray-500 block mb-1">Cantidad Actual en Almac√©n</label>
                                                        <input type="number" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white font-bold"
                                                            value={form.stock} onChange={e => setForm({ ...form, stock: e.target.value })} />
                                                    </div>
                                                )}
                                                {!form.trackStock && <p className="text-xs text-gray-400">El producto tendr√° stock infinito (servicios, men√∫s, etc).</p>}
                                            </div>

                                            {currentLocation === 'all' && (
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500 block mb-1">Asignar a Local</label>
                                                    <select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.locationId || 'main'} onChange={e => setForm({ ...form, locationId: e.target.value })}>
                                                        {config.locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                                                    </select>
                                                </div>
                                            )}

                                            <input type="file" onChange={handleImage} className="w-full text-sm dark:text-gray-400" />
                                            <div className="flex justify-end gap-2 mt-4">
                                                <button type="button" onClick={() => setIsEditing(false)} className="px-4 py-2 text-gray-600 dark:text-gray-400">Cancelar</button>
                                                <button type="submit" className="px-6 py-2 bg-emerald-600 text-white rounded font-bold">Guardar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const CustomersView = () => {
                const [isEditing, setIsEditing] = useState(false);
                const [viewHistory, setViewHistory] = useState(null);
                const [filterPeriod, setFilterPeriod] = useState('monthly');
                const [form, setForm] = useState({ name: '', phone: '', type: 'Personal', level: 'Primaria', grade: '1ro', section: 'A', guardian: '', credit: 0, blocked: false });
                const [search, setSearch] = useState("");
                const [typeFilter, setTypeFilter] = useState('Todos');
                const [filterLevel, setFilterLevel] = useState('Todos');
                const [filterGrade, setFilterGrade] = useState('Todos');
                const [filterSection, setFilterSection] = useState('Todos');
                const [transactionAmount, setTransactionAmount] = useState("");
                const [transactionDate, setTransactionDate] = useState(getCurrentDateTimeLocal());
                const [transComment, setTransComment] = useState("");
                const [financialFilter, setFinancialFilter] = useState('all');
                const [editingTransaction, setEditingTransaction] = useState(null);
                const appMode = getCurrentMode();

                const adjustCredit = async (customer, amount, type) => {
                    const val = parseFloat(amount); if (!val) return;
                    const tDate = new Date(transactionDate).getTime();
                    const method = type === 'pay' ? 'Abono' : 'Cargo Manual';
                    const newCredit = type === 'pay' ? customer.credit - val : customer.credit + val;
                    await saveData('customers', { credit: newCredit }, customer.id);
                    await saveData('orders', { customerId: customer.id, customerName: customer.name, date: tDate, total: val, method: method, items: [{ name: type === 'pay' ? 'Abono Manual' : 'Cargo Manual', quantity: 1, price: val }], status: 'Completado', locationId: currentLocation === 'all' ? 'main' : currentLocation, comment: transComment });
                    if (viewHistory && viewHistory.id === customer.id) setViewHistory({ ...viewHistory, credit: newCredit });
                    setTransComment("");
                };

                const handleAnnul = async (transaction) => {
                    if (transaction.status === 'Anulado') return;
                    if (!confirm("¬øEst√°s seguro de ANULAR este movimiento?")) return;

                    let diff = 0;
                    // Solo revertir cr√©dito si la transacci√≥n afect√≥ el cr√©dito (Cargo, Cr√©dito, Abono)
                    // Las ventas al contado (Efectivo/Yape) no afectan saldo, solo se marcan anuladas.
                    if (transaction.method === 'Cargo Manual' || transaction.method === 'Credit') {
                        diff = -transaction.total;
                    } else if (transaction.method === 'Abono') {
                        diff = transaction.total;
                    }

                    const newCredit = viewHistory.credit + diff;

                    if (diff !== 0) {
                        await saveData('customers', { credit: newCredit }, viewHistory.id);
                        setViewHistory({ ...viewHistory, credit: newCredit });
                    }

                    await saveData('orders', { ...transaction, status: 'Anulado', comment: transaction.comment ? transaction.comment + " [ANULADO]" : "[ANULADO]" }, transaction.id);
                };

                const handleEditTransaction = async (e) => {
                    e.preventDefault();
                    if (!editingTransaction) return;
                    const oldTotal = editingTransaction.originalTotal;
                    const newTotal = parseFloat(editingTransaction.total);
                    const diff = newTotal - oldTotal;
                    let creditAdjustment = 0;

                    if (editingTransaction.method === 'Cargo Manual' || editingTransaction.method === 'Credit') {
                        creditAdjustment = diff;
                    } else if (editingTransaction.method === 'Abono') {
                        creditAdjustment = -diff;
                    }

                    if (creditAdjustment !== 0) {
                        const newCredit = viewHistory.credit + creditAdjustment;
                        await saveData('customers', { credit: newCredit }, viewHistory.id);
                        setViewHistory({ ...viewHistory, credit: newCredit });
                    }

                    const { originalTotal, ...orderToSave } = editingTransaction;
                    await saveData('orders', orderToSave, orderToSave.id);
                    setEditingTransaction(null);
                };

                const localCustomers = customers.filter(checkLocation);
                const filtered = localCustomers.filter(c => {
                    const matchesSearch = c.name.toLowerCase().includes(search.toLowerCase()) || c.guardian?.toLowerCase().includes(search.toLowerCase());
                    const matchesType = typeFilter === 'Todos' || c.type === typeFilter;
                    let matchesKiosk = true;
                    if (appMode === 'kiosk' && c.type === 'Alumno') {
                        if (filterLevel !== 'Todos' && c.level !== filterLevel) matchesKiosk = false;
                        if (filterGrade !== 'Todos' && c.grade !== filterGrade) matchesKiosk = false;
                        if (filterSection !== 'Todos' && c.section !== filterSection) matchesKiosk = false;
                    }
                    let matchesFinancial = true;
                    if (financialFilter === 'debt') matchesFinancial = c.credit > 0;
                    if (financialFilter === 'credit') matchesFinancial = c.credit <= 0;
                    return matchesSearch && matchesType && matchesKiosk && matchesFinancial;
                });

                const handleSave = async (e) => { e.preventDefault(); let locId = form.locationId; if (!locId) locId = currentLocation === 'all' ? 'main' : currentLocation; await saveData('customers', { ...form, locationId: locId }, form.id); setIsEditing(false); };
                const handleNewCustomer = () => { setForm({ name: '', phone: '', type: 'Personal', level: 'Primaria', grade: '1ro', section: 'A', guardian: '', credit: 0, blocked: false }); setIsEditing(true); };
                const getFilteredMovements = (customerId) => {
                    const now = new Date();
                    return orders.filter(o => {
                        if (o.customerId !== customerId) return false;
                        const d = new Date(o.date);
                        const diffDays = Math.ceil(Math.abs(now - d) / (1000 * 60 * 60 * 24));
                        if (filterPeriod === 'daily') return diffDays <= 1;
                        if (filterPeriod === 'weekly') return diffDays <= 7;
                        if (filterPeriod === 'biweekly') return diffDays <= 15;
                        if (filterPeriod === 'monthly') return diffDays <= 30;
                        return true;
                    }).sort((a, b) => b.date - a.date);
                };

                return (
                    <div className="scroll-view">
                        <div className="p-4 md:p-6 pb-32 space-y-4">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4"><h2 className="text-2xl font-bold text-emerald-900 dark:text-emerald-100">{appMode === 'kiosk' ? 'Comunidad Escolar' : 'Clientes'}</h2><button onClick={handleNewCustomer} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">{Plus && <Plus size={18} />} Nuevo</button></div>
                            <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-700 space-y-2">
                                {appMode === 'kiosk' && (<div className="flex gap-2 flex-wrap pb-2 border-b border-gray-100 dark:border-slate-700">{['Todos', 'Alumno', 'Profesor', 'Personal'].map(type => (<button key={type} onClick={() => setTypeFilter(type)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${typeFilter === type ? 'bg-emerald-600 text-white shadow' : 'bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-300 hover:bg-gray-200'}`}>{type}s</button>))}</div>)}
                                {appMode === 'kiosk' && typeFilter === 'Alumno' && (<div className="flex gap-2 flex-wrap"><select className="p-1 border dark:border-slate-600 rounded text-xs bg-white dark:bg-slate-700 dark:text-white" value={filterLevel} onChange={e => setFilterLevel(e.target.value)}><option value="Todos">Nivel</option><option value="Primaria">Primaria</option><option value="Secundaria">Secundaria</option></select><select className="p-1 border dark:border-slate-600 rounded text-xs bg-white dark:bg-slate-700 dark:text-white" value={filterGrade} onChange={e => setFilterGrade(e.target.value)}><option value="Todos">Grado</option>{[1, 2, 3, 4, 5, 6].map(g => <option key={g} value={`${g}do`}>{g}¬∞</option>)}</select><select className="p-1 border dark:border-slate-600 rounded text-xs bg-white dark:bg-slate-700 dark:text-white" value={filterSection} onChange={e => setFilterSection(e.target.value)}><option value="Todos">Sec</option>{['A', 'B', 'C', 'D', 'E'].map(s => <option key={s} value={s}>{s}</option>)}</select></div>)}
                                <div className="flex gap-2 flex-wrap pt-1"><button onClick={() => setFinancialFilter('all')} className={`px-3 py-1 rounded-full text-xs font-bold border transition ${financialFilter === 'all' ? 'bg-gray-800 dark:bg-gray-600 text-white border-gray-800 dark:border-gray-600' : 'bg-white dark:bg-slate-700 text-gray-500 dark:text-gray-300'}`}>Todos</button><button onClick={() => setFinancialFilter('debt')} className={`px-3 py-1 rounded-full text-xs font-bold border transition flex items-center gap-1 ${financialFilter === 'debt' ? 'bg-red-500 text-white border-red-500' : 'bg-white dark:bg-slate-700 text-red-500 border-red-200 dark:border-red-900'}`}>{TrendingDown && <TrendingDown size={12} />} Con Deuda</button><button onClick={() => setFinancialFilter('credit')} className={`px-3 py-1 rounded-full text-xs font-bold border transition flex items-center gap-1 ${financialFilter === 'credit' ? 'bg-green-500 text-white border-green-500' : 'bg-white dark:bg-slate-700 text-green-500 border-green-200 dark:border-green-900'}`}>{TrendingUp && <TrendingUp size={12} />} Saldo a Favor</button></div>
                            </div>
                            <input className="w-full p-3 border dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none dark:bg-slate-700 dark:text-white" placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} />
                            <div className="flex flex-col gap-2">{filtered.map(c => { const isDebt = c.credit > 0; const isCredit = c.credit < 0; return (<div key={c.id} className={`bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 flex flex-col md:flex-row justify-between items-center gap-4 ${isDebt ? 'border-red-500 bg-red-50/50 dark:bg-red-900/20' : (isCredit ? 'border-green-500 bg-green-50/50 dark:bg-green-900/20' : 'border-gray-300 dark:border-slate-600')}`}><div className="flex-1 w-full"><div className="flex justify-between items-start"><h4 className={`font-bold text-lg ${isDebt ? 'text-red-700 dark:text-red-400' : (isCredit ? 'text-green-700 dark:text-green-400' : 'text-gray-800 dark:text-gray-200')}`}>{c.name}</h4>{c.blocked && (Ban && <Ban size={18} className="text-red-500" />)}</div><div className="text-sm text-gray-600 dark:text-gray-400 flex flex-wrap gap-4 mt-1">{appMode === 'kiosk' && c.type !== 'Personal' && <span className="bg-white/80 dark:bg-slate-700 px-2 py-0.5 rounded border border-gray-200 dark:border-slate-600 text-xs">{c.level} {c.grade} "{c.section}"</span>}{appMode === 'kiosk' && c.guardian && <span className="text-xs text-gray-500 dark:text-gray-400">Apod: {c.guardian}</span>}{appMode === 'kiosk' && <span className="text-xs text-gray-500 dark:text-gray-400 font-bold bg-gray-100 dark:bg-slate-700 px-2 rounded">{c.type}</span>}</div></div><div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end"><div className="text-right"><p className="text-[10px] uppercase font-bold text-gray-400">{isDebt ? 'Debe' : (isCredit ? 'A Favor' : 'Saldo')}</p><p className={`font-bold text-lg ${isDebt ? 'text-red-600 dark:text-red-400' : (isCredit ? 'text-green-600 dark:text-green-400' : 'text-gray-400')}`}>{isCredit ? '+' : ''}{formatMoney(Math.abs(c.credit), config.currency)}</p></div><div className="flex gap-2"><button onClick={() => { setViewHistory(c); setTransactionAmount(""); setTransactionDate(getCurrentDateTimeLocal()); }} className="p-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600">{History && <History size={20} />}</button><button onClick={() => { setForm({ ...c, phone: c.phone || '', guardian: c.guardian || '', section: c.section || 'A', blocked: c.blocked || false }); setIsEditing(true); }} className="p-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-600 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600">{FileText && <FileText size={20} />}</button><button onClick={() => deleteData('customers', c.id)} className="p-2 bg-white dark:bg-slate-700 border border-red-100 dark:border-red-900 text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30">{Trash2 && <Trash2 size={20} />}</button></div></div></div>); })}</div>
                            {isEditing && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto"><h3 className="text-xl font-bold mb-4 dark:text-white">{form.id ? 'Editar' : 'Nuevo'} Registro</h3><form onSubmit={handleSave} className="space-y-4"><div><label className="text-sm font-bold text-gray-700 dark:text-gray-300">Tipo de Cliente</label><select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.type || 'Personal'} onChange={e => setForm({ ...form, type: e.target.value })}><option value="Personal">Personal / Externo</option>{appMode === 'kiosk' && <option value="Alumno">Alumno</option>}{appMode === 'kiosk' && <option value="Profesor">Profesor</option>}{appMode === 'kiosk' && <option value="Personal">Personal Administrativo</option>}</select></div><input required placeholder="Nombre Completo" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.name || ''} onChange={e => setForm({ ...form, name: e.target.value })} />{appMode === 'kiosk' && form.type === 'Alumno' && (<div className="grid grid-cols-3 gap-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600"><div><label className="text-xs font-bold dark:text-gray-300">Nivel</label><select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white" value={form.level || 'Primaria'} onChange={e => setForm({ ...form, level: e.target.value })}><option value="Primaria">Primaria</option><option value="Secundaria">Secundaria</option></select></div><div><label className="text-xs font-bold dark:text-gray-300">Grado</label><select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white" value={form.grade || '1ro'} onChange={e => setForm({ ...form, grade: e.target.value })}>{[1, 2, 3, 4, 5, 6].map(g => (form.level === 'Secundaria' && g > 5) ? null : <option key={g} value={`${g}do`}>{g}¬∞</option>)}</select></div><div><label className="text-xs font-bold dark:text-gray-300">Secci√≥n</label><select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white" value={form.section || 'A'} onChange={e => setForm({ ...form, section: e.target.value })}>{['A', 'B', 'C', 'D', 'E'].map(s => <option key={s} value={s}>{s}</option>)}</select></div><div className="col-span-3"><input placeholder="Nombre del Apoderado (Opcional)" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-800 dark:text-white" value={form.guardian || ''} onChange={e => setForm({ ...form, guardian: e.target.value })} /></div></div>)}{currentLocation === 'all' && (<div><label className="text-xs font-bold text-gray-500 block mb-1">Asignar a Local</label><select className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.locationId || 'main'} onChange={e => setForm({ ...form, locationId: e.target.value })}>{config.locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}</select></div>)}<input placeholder="Tel√©fono" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={form.phone || ''} onChange={e => setForm({ ...form, phone: e.target.value })} /><div className="flex gap-4 items-center border-t dark:border-slate-700 pt-4"><div className="flex-1"><label className="text-sm font-bold text-red-600">Deuda Inicial</label><input type="number" step="0.01" className="w-full p-2 border dark:border-slate-600 rounded text-red-600 font-bold dark:bg-slate-700" value={form.credit || 0} onChange={e => setForm({ ...form, credit: parseFloat(e.target.value) })} /></div><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="w-5 h-5 accent-red-500" checked={form.blocked || false} onChange={e => setForm({ ...form, blocked: e.target.checked })} /><span className="text-sm font-bold text-gray-700 dark:text-gray-300">Bloquear Cr√©dito</span></label></div><div className="flex justify-end gap-2 mt-6"><button type="button" onClick={() => setIsEditing(false)} className="px-4 py-2 text-gray-600 dark:text-gray-400">Cancelar</button><button type="submit" className="px-6 py-2 bg-emerald-600 text-white rounded font-bold">Guardar</button></div></form></div></div>)}
                            {editingTransaction && (<div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4"><div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-sm p-6 shadow-xl"><h3 className="text-lg font-bold mb-4 dark:text-white">Editar Movimiento</h3><form onSubmit={handleEditTransaction} className="space-y-4"><div><label className="text-xs font-bold text-gray-500 dark:text-gray-400">Monto</label><input type="number" step="0.01" className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white font-bold" value={editingTransaction.total} onChange={e => setEditingTransaction({ ...editingTransaction, total: e.target.value })} /></div><div><label className="text-xs font-bold text-gray-500 dark:text-gray-400">Comentario</label><textarea className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white h-20 resize-none" value={editingTransaction.comment || ''} onChange={e => setEditingTransaction({ ...editingTransaction, comment: e.target.value })} /></div><div className="flex justify-end gap-2"><button type="button" onClick={() => setEditingTransaction(null)} className="px-3 py-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button><button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded font-bold">Guardar Cambios</button></div></form></div></div>)}
                            {viewHistory && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-3xl p-6 h-[85vh] flex flex-col"><div className="flex justify-between items-start mb-4"><div><h3 className="text-xl font-bold text-emerald-900 dark:text-emerald-100">{viewHistory.name}</h3><p className="text-sm text-gray-500 dark:text-gray-400">Historial de Movimientos</p></div><button onClick={() => setViewHistory(null)}>{X && <X className="text-gray-400" />}</button></div><div className="flex flex-col gap-2 mb-4 bg-gray-50 dark:bg-slate-700 p-3 rounded-lg border dark:border-slate-600"><div className="flex justify-between items-center"><span className="text-sm font-bold text-gray-600 dark:text-gray-300">Gestionar Cr√©dito</span><input type="datetime-local" className="text-xs bg-transparent border-b border-gray-300 dark:border-slate-500 outline-none dark:text-white" value={transactionDate} onChange={e => setTransactionDate(e.target.value)} /></div><div className="flex gap-2"><input type="number" placeholder="0.00" className="w-1/3 p-2 border dark:border-slate-600 rounded text-right font-mono dark:bg-slate-800 dark:text-white" value={transactionAmount} onChange={e => setTransactionAmount(e.target.value)} /><input type="text" placeholder="Comentario..." className="flex-1 p-2 border dark:border-slate-600 rounded text-sm dark:bg-slate-800 dark:text-white" value={transComment} onChange={e => setTransComment(e.target.value)} /></div><div className="flex gap-2"><button onClick={() => { adjustCredit(viewHistory, transactionAmount, 'pay'); setTransactionAmount(""); }} className="flex-1 bg-green-600 text-white px-2 py-2 rounded font-bold hover:bg-green-700 flex items-center justify-center gap-1">{ArrowDown && <ArrowDown size={16} />} Abonar</button><button onClick={() => { adjustCredit(viewHistory, transactionAmount, 'charge'); setTransactionAmount(""); }} className="flex-1 bg-red-600 text-white px-2 py-2 rounded font-bold hover:bg-red-700 flex items-center justify-center gap-1">{ArrowUp && <ArrowUp size={16} />} Cargar</button></div></div><div className="flex justify-between items-center mb-2"><select className="bg-white dark:bg-slate-700 dark:text-white border dark:border-slate-600 p-2 rounded text-sm" value={filterPeriod} onChange={e => setFilterPeriod(e.target.value)}><option value="daily">Diario</option><option value="weekly">Semanal</option><option value="biweekly">Quincenal</option><option value="monthly">Mensual</option></select><button onClick={() => PDFService.generateCustomerStatement(viewHistory, getFilteredMovements(viewHistory.id), filterPeriod, config)} className="bg-gray-800 dark:bg-slate-600 text-white px-3 py-2 rounded text-sm font-bold flex items-center gap-2 hover:bg-gray-900">{Download && <Download size={16} />} PDF</button></div><div className="flex-1 overflow-y-auto border dark:border-slate-600 rounded-lg"><table className="w-full text-sm text-left"><thead className="bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Detalle</th><th className="p-3 text-right">Monto</th><th className="p-3 text-center">Acciones</th></tr></thead><tbody>{getFilteredMovements(viewHistory.id).map(m => (<tr key={m.id} className={`border-b dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700 ${m.status === 'Anulado' ? 'opacity-50 grayscale' : ''}`}><td className="p-3"><div className="font-bold dark:text-gray-200">{new Date(m.date).toLocaleDateString()}</div><div className="text-xs text-gray-500">{new Date(m.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div></td><td className="p-3"><div className="line-clamp-2 dark:text-gray-300">{m.status === 'Anulado' && <span className="text-red-500 font-bold mr-1">[ANULADO]</span>}{m.method === 'Abono' ? <span className="font-bold text-green-600 flex items-center gap-1">ABONO A CUENTA</span> : (m.method === 'Cargo Manual' ? <span className="font-bold text-red-600 flex items-center gap-1">CARGO MANUAL</span> : m.items.map(i => `${i.quantity}x ${i.name}`).join(', '))}</div>{m.comment && <p className="text-xs text-gray-500 italic mt-1">"{m.comment}"</p>}<span className={`text-xs px-2 py-0.5 rounded ${m.method === 'Credit' ? 'bg-orange-100 text-orange-800' : (m.method === 'Abono' ? 'bg-green-100 text-green-800' : (m.method === 'Cargo Manual' ? 'bg-red-100 text-red-800' : 'bg-gray-200 text-gray-700'))}`}>{m.method === 'Credit' ? 'Fiado' : m.method}</span></td><td className={`p-3 text-right font-bold ${m.method === 'Abono' ? 'text-green-600' : 'text-red-600'}`}>{m.method === 'Abono' ? '-' : '+'}{formatMoney(m.total, config.currency)}</td><td className="p-3 text-center">{m.status !== 'Anulado' && (<div className="flex gap-1 justify-center"><button onClick={() => setEditingTransaction({ ...m, originalTotal: m.total })} className="p-1.5 bg-blue-50 text-blue-600 rounded hover:bg-blue-100" title="Editar">{Edit3 && <Edit3 size={16} />}</button><button onClick={() => handleAnnul(m)} className="p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100" title="Anular">{XCircle && <XCircle size={16} />}</button></div>)}</td></tr>))}</tbody></table></div><div className="mt-4 pt-4 border-t dark:border-slate-600 flex justify-between items-center bg-red-50 dark:bg-red-900/20 p-4 rounded-lg"><span className="font-bold text-red-900 dark:text-red-300 text-sm">Deuda Total:</span><span className="text-2xl font-bold text-red-600 dark:text-red-400">{formatMoney(viewHistory.credit, config.currency)}</span></div></div></div>)}
                        </div>
                    </div>
                );
            };

            const ConfigView = () => {
                const [local, setLocal] = useState(config);
                const [newLocName, setNewLocName] = useState('');
                const [newLocMode, setNewLocMode] = useState('normal');
                // C√ìDIGO CORREGIDO
                const handleSave = async () => {
                    // A√±adimos 'local.id' al final para que sepa QU√â documento actualizar
                    await saveData('config', local, local.id);
                    alert("Guardado");
                }; const handleLogo = async (e, k) => { setLocal({ ...local, [k]: await compressImage(e.target.files[0]) }); };
                const addLocation = () => { if (!newLocName.trim()) return; const newId = newLocName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-4); setLocal(prev => ({ ...prev, locations: [...prev.locations, { id: newId, name: newLocName, mode: newLocMode }] })); setNewLocName(''); };
                const updateLocation = (id, field, value) => { setLocal(prev => ({ ...prev, locations: prev.locations.map(l => l.id === id ? { ...l, [field]: value } : l) })); };
                const removeLocation = (id) => { if (id === 'main') return alert("No se puede eliminar la sede principal"); if (confirm("¬øEliminar este local? Los datos asociados podr√≠an quedar hu√©rfanos.")) { setLocal(prev => ({ ...prev, locations: prev.locations.filter(l => l.id !== id) })); } };
                return (<div className="scroll-view"><div className="max-w-2xl mx-auto p-4 md:p-8 space-y-6 pb-32"><h2 className="text-2xl font-bold text-emerald-900 dark:text-emerald-100 border-b dark:border-slate-700 pb-4">Configuraci√≥n</h2><div className="flex items-center justify-between bg-emerald-50 dark:bg-slate-700 p-4 rounded-lg border border-emerald-200 dark:border-slate-600"><span className="font-bold text-emerald-900 dark:text-white flex items-center gap-2">{local.darkMode ? <Moon size={20} /> : <Sun size={20} />} Modo Oscuro</span><label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" className="sr-only peer" checked={local.darkMode} onChange={() => setLocal({ ...local, darkMode: !local.darkMode })} /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div></label></div><div className="bg-white dark:bg-slate-800 p-4 rounded-lg border dark:border-slate-700"><h3 className="font-bold text-gray-800 dark:text-white mb-3 flex items-center gap-2">{Globe && <Globe size={18} />} Gesti√≥n de Locales (Sucursales)</h3><div className="space-y-3 mb-4">{local.locations.map(loc => (<div key={loc.id} className="flex flex-col sm:flex-row gap-2 items-start sm:items-center p-3 bg-gray-50 dark:bg-slate-700 rounded border dark:border-slate-600"><div className="flex-1 w-full"><label className="text-[10px] text-gray-400 uppercase font-bold">Nombre</label><input className="w-full bg-transparent font-bold dark:text-white outline-none border-b border-transparent hover:border-gray-300 focus:border-emerald-500 transition" value={loc.name} onChange={(e) => updateLocation(loc.id, 'name', e.target.value)} /></div><div className="flex items-center gap-2 w-full sm:w-auto"><div className="flex-1 sm:flex-none"><label className="text-[10px] text-gray-400 uppercase font-bold">Modo</label><select className="w-full bg-white dark:bg-slate-800 text-sm p-1 rounded border dark:border-slate-600 dark:text-white outline-none" value={loc.mode || 'normal'} onChange={(e) => updateLocation(loc.id, 'mode', e.target.value)}><option value="normal">Normal</option><option value="kiosk">Kiosko</option></select></div>{loc.id !== 'main' && <button onClick={() => removeLocation(loc.id)} className="text-red-500 hover:text-red-700 p-2">{Trash2 && <Trash2 size={16} />}</button>}</div></div>))}</div><div className="flex flex-col sm:flex-row gap-2 bg-gray-50 dark:bg-slate-900 p-3 rounded-lg"><input className="flex-1 p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" placeholder="Nombre nueva sucursal..." value={newLocName} onChange={e => setNewLocName(e.target.value)} /><select className="p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white text-sm" value={newLocMode} onChange={e => setNewLocMode(e.target.value)}><option value="normal">Normal</option><option value="kiosk">Kiosko</option></select><button onClick={addLocation} className="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Agregar</button></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1 dark:text-white">Nombre Empresa</label><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={local.storeName} onChange={e => setLocal({ ...local, storeName: e.target.value })} /></div><div><label className="block text-sm font-bold mb-1 dark:text-white">Moneda</label><input className="w-full p-2 border dark:border-slate-600 rounded dark:bg-slate-700 dark:text-white" value={local.currency} onChange={e => setLocal({ ...local, currency: e.target.value })} /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="border-2 border-dashed dark:border-slate-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 relative">{local.logo ? <img src={local.logo} className="h-20 mx-auto object-contain" /> : <span className="text-gray-400 text-sm">Logo (Click)</span>}<input type="file" className="absolute inset-0 opacity-0" onChange={e => handleLogo(e, 'logo')} /></div><div className="border-2 border-dashed dark:border-slate-600 rounded-lg p-4 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700 relative">{local.qrImage ? <img src={local.qrImage} className="h-20 mx-auto object-contain" /> : <span className="text-gray-400 text-sm">QR (Click)</span>}<input type="file" className="absolute inset-0 opacity-0" onChange={e => handleLogo(e, 'qrImage')} /></div></div><button onClick={handleSave} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700">Guardar</button></div></div>);
            };

            const ReportsView = () => {
                const [reportData, setReportData] = useState({ sales: [], expenses: [] });
                const [dateRange, setDateRange] = useState('today');
                const [loading, setLoading] = useState(true);
                const [showGraphs, setShowGraphs] = useState(false);

                useEffect(() => {
                    setLoading(true);

                    try {
                        const { collection, onSnapshot, query, where } = window.firebaseModules;

                        // Calcular rango de fechas
                        const now = new Date();
                        let start = new Date();

                        if (dateRange === 'today') {
                            start.setHours(0, 0, 0, 0);
                        } else if (dateRange === 'week') {
                            start.setDate(now.getDate() - 7);
                        } else if (dateRange === 'month') {
                            start.setMonth(now.getMonth() - 1);
                        }

                        const startTime = start.getTime();

                        let unsubSales, unsubExp;

                        // Cargar ventas
                        const qSales = query(
                            collection(db.current, 'artifacts', appId, 'public', 'data', 'orders'),
                            where('date', '>=', startTime)
                        );

                        unsubSales = onSnapshot(qSales, (snap) => {
                            const sales = snap.docs
                                .map(d => d.data())
                                .filter(o => checkLocation(o) && o.status !== 'Anulado');

                            // Cargar gastos
                            const qExp = query(
                                collection(db.current, 'artifacts', appId, 'public', 'data', 'expenses'),
                                where('date', '>=', startTime)
                            );

                            unsubExp = onSnapshot(qExp, (snapExp) => {
                                const exp = snapExp.docs
                                    .map(d => d.data())
                                    .filter(checkLocation);

                                setReportData({ sales, expenses: exp });
                                setLoading(false);
                            });
                        });

                        return () => {
                            if (unsubSales) unsubSales();
                            if (unsubExp) unsubExp();
                        };
                    } catch (error) {
                        console.error("Error cargando reportes:", error);
                        setLoading(false);
                    }
                }, [dateRange, currentLocation]);

                // C√°lculos separando fiados y contado
                const salesContado = reportData.sales.filter(s => s.method !== 'Fiado' && !s.fiado);
                const salesFiado = reportData.sales.filter(s => s.method === 'Fiado' || s.fiado);

                const totalSalesContado = salesContado.reduce((acc, curr) => acc + (curr.total || 0), 0);
                const totalSalesFiado = salesFiado.reduce((acc, curr) => acc + (curr.total || 0), 0);
                const totalSales = totalSalesContado + totalSalesFiado;

                // Separar ventas de Men√∫ vs Otros (POS/Carta)
                const salesMenu = reportData.sales.filter(s => s.customerName === 'Cliente Men√∫' || s.customerId === 'menu_dia');
                const salesOtros = reportData.sales.filter(s => s.customerName !== 'Cliente Men√∫' && s.customerId !== 'menu_dia');

                const totalSalesMenu = salesMenu.reduce((acc, curr) => acc + (curr.total || 0), 0);
                const totalSalesOtros = salesOtros.reduce((acc, curr) => acc + (curr.total || 0), 0);

                const totalExpenses = reportData.expenses.reduce((acc, curr) => acc + (curr.amount || 0), 0);

                const netProfitContado = totalSalesContado - totalExpenses;
                const netProfitTotal = totalSales - totalExpenses;

                // Ventas por m√©todo
                const byMethod = reportData.sales.reduce((acc, curr) => {
                    const method = curr.method || 'Efectivo';
                    acc[method] = (acc[method] || 0) + (curr.total || 0);
                    return acc;
                }, {});

                // Gastos por categor√≠a
                const expByCategory = reportData.expenses.reduce((acc, curr) => {
                    const cat = curr.category || 'Otros';
                    acc[cat] = (acc[cat] || 0) + (curr.amount || 0);
                    return acc;
                }, {});

                // Funci√≥n para exportar a PDF
                const exportToPDF = () => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        // T√≠tulo
                        doc.setFontSize(20);
                        doc.setTextColor(16, 185, 129);
                        doc.text('REPORTE FINANCIERO', 105, 20, { align: 'center' });

                        // Subt√≠tulo con fecha
                        doc.setFontSize(10);
                        doc.setTextColor(100);
                        const rangeText = dateRange === 'today' ? 'Hoy' : (dateRange === 'week' ? '√öltimos 7 D√≠as' : '√öltimo Mes');
                        doc.text(`Periodo: ${rangeText} | ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });

                        let y = 45;

                        // SECCI√ìN INGRESOS
                        doc.setFontSize(14);
                        doc.setTextColor(0);
                        doc.text('INGRESOS', 20, y);
                        y += 8;

                        doc.setFontSize(10);
                        doc.text(`Ventas al Contado: ${formatMoney(totalSalesContado, config.currency)}`, 25, y);
                        y += 6;
                        doc.text(`Ventas Fiadas: ${formatMoney(totalSalesFiado, config.currency)}`, 25, y);
                        y += 6;
                        doc.setFont(undefined, 'bold');
                        doc.text(`TOTAL INGRESOS: ${formatMoney(totalSales, config.currency)}`, 25, y);
                        doc.setFont(undefined, 'normal');
                        y += 10;

                        // SECCI√ìN GASTOS
                        doc.setFontSize(14);
                        doc.text('GASTOS OPERATIVOS', 20, y);
                        y += 8;

                        doc.setFontSize(10);
                        Object.entries(expByCategory).forEach(([cat, amount]) => {
                            doc.text(`${cat}: ${formatMoney(amount, config.currency)}`, 25, y);
                            y += 6;
                        });
                        doc.setFont(undefined, 'bold');
                        doc.text(`TOTAL GASTOS: ${formatMoney(totalExpenses, config.currency)}`, 25, y);
                        doc.setFont(undefined, 'normal');
                        y += 10;

                        // SECCI√ìN UTILIDAD
                        doc.setFontSize(14);
                        doc.text('UTILIDAD NETA', 20, y);
                        y += 8;

                        doc.setFontSize(10);
                        doc.text(`Utilidad (Solo Contado): ${formatMoney(netProfitContado, config.currency)}`, 25, y);
                        y += 6;
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(netProfitTotal >= 0 ? 37 : 220, netProfitTotal >= 0 ? 99 : 38, netProfitTotal >= 0 ? 235 : 38);
                        doc.text(`UTILIDAD TOTAL: ${formatMoney(netProfitTotal, config.currency)}`, 25, y);
                        y += 10;

                        // TABLA DE M√âTODOS DE PAGO
                        if (Object.keys(byMethod).length > 0) {
                            doc.setTextColor(0);
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(12);
                            y += 5;
                            doc.text('INGRESOS POR M√âTODO DE PAGO', 20, y);
                            y += 5;

                            doc.autoTable({
                                startY: y,
                                head: [['M√©todo', 'Monto']],
                                body: Object.entries(byMethod).map(([method, amount]) => [
                                    method,
                                    formatMoney(amount, config.currency)
                                ]),
                                theme: 'grid',
                                headStyles: { fillColor: [16, 185, 129] },
                                margin: { left: 20 }
                            });
                        }

                        // Pie de p√°gina
                        const pageCount = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            doc.setPage(i);
                            doc.setFontSize(8);
                            doc.setTextColor(150);
                            doc.text(`Generado por ${config.storeName} - P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                        }

                        // Guardar
                        doc.save(`Reporte_${dateRange}_${new Date().toISOString().split('T')[0]}.pdf`);

                        // Mostrar alerta bonita
                        showCustomAlert('‚úÖ PDF generado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error generando PDF:', error);
                        showCustomAlert('‚ùå Error al generar PDF', 'error');
                    }
                };

                // Funci√≥n para exportar a Excel
                const exportToExcel = () => {
                    try {
                        // Crear datos para Excel
                        const rangeText = dateRange === 'today' ? 'Hoy' : (dateRange === 'week' ? '√öltimos 7 D√≠as' : '√öltimo Mes');

                        // RESUMEN
                        const resumenData = [
                            ['REPORTE FINANCIERO'],
                            [`Periodo: ${rangeText} | ${new Date().toLocaleDateString()}`],
                            [''],
                            ['RESUMEN'],
                            ['Concepto', 'Monto'],
                            ['Ingresos Men√∫', formatMoney(totalSalesMenu, config.currency)],
                            ['Ingresos Otros (POS/Carta)', formatMoney(totalSalesOtros, config.currency)],
                            ['Ingresos Contado', formatMoney(totalSalesContado, config.currency)],
                            ['Ingresos Fiado', formatMoney(totalSalesFiado, config.currency)],
                            ['TOTAL INGRESOS', formatMoney(totalSales, config.currency)],
                            [''],
                            ['Gastos Operativos', formatMoney(totalExpenses, config.currency)],
                            [''],
                            ['Utilidad Neta (Contado)', formatMoney(netProfitContado, config.currency)],
                            ['Utilidad Neta (Total)', formatMoney(netProfitTotal, config.currency)],
                            ['']
                        ];

                        // DETALLE DE VENTAS
                        const ventasData = [
                            ['DETALLE DE VENTAS'],
                            ['Fecha', 'Cliente', 'Tipo', 'Total', 'M√©todo', 'Estado'],
                        ];

                        reportData.sales.forEach(s => {
                            const tipo = s.customerName === 'Cliente Men√∫' ? 'Men√∫' : 'Otros';
                            ventasData.push([
                                new Date(s.date).toLocaleString(),
                                s.customerName || 'N/A',
                                tipo,
                                (s.total || 0).toFixed(2),
                                s.method || 'Efectivo',
                                s.status || 'N/A'
                            ]);
                        });

                        ventasData.push(['']);
                        ventasData.push(['TOTAL', '', '', totalSales.toFixed(2), '', '']);

                        // DETALLE DE GASTOS
                        const gastosData = [
                            [''],
                            ['DETALLE DE GASTOS'],
                            ['Fecha', 'Descripci√≥n', 'Categor√≠a', 'Monto'],
                        ];

                        reportData.expenses.forEach(e => {
                            gastosData.push([
                                new Date(e.date).toLocaleString(),
                                e.description || 'N/A',
                                e.category || 'Otros',
                                (e.amount || 0).toFixed(2)
                            ]);
                        });

                        gastosData.push(['']);
                        gastosData.push(['TOTAL', '', '', totalExpenses.toFixed(2)]);

                        // INGRESOS POR M√âTODO
                        const metodosData = [
                            [''],
                            ['INGRESOS POR M√âTODO DE PAGO'],
                            ['M√©todo', 'Monto', 'Porcentaje'],
                        ];

                        Object.entries(byMethod).forEach(([method, amount]) => {
                            const percentage = totalSales > 0 ? ((amount / totalSales) * 100).toFixed(1) : 0;
                            metodosData.push([method, amount.toFixed(2), `${percentage}%`]);
                        });

                        // GASTOS POR CATEGOR√çA
                        const catGastosData = [
                            [''],
                            ['GASTOS POR CATEGOR√çA'],
                            ['Categor√≠a', 'Monto', 'Porcentaje'],
                        ];

                        Object.entries(expByCategory).forEach(([cat, amount]) => {
                            const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
                            catGastosData.push([cat, amount.toFixed(2), `${percentage}%`]);
                        });

                        // Combinar todo
                        const allData = [
                            ...resumenData,
                            ...ventasData,
                            ...gastosData,
                            ...metodosData,
                            ...catGastosData
                        ];

                        // Convertir a CSV
                        let csv = allData.map(row => row.join(',')).join('\n');

                        // Crear blob y descargar
                        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);

                        link.setAttribute('href', url);
                        link.setAttribute('download', `Reporte_${dateRange}_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showCustomAlert('‚úÖ Excel generado exitosamente', 'success');
                    } catch (error) {
                        console.error('Error generando Excel:', error);
                        showCustomAlert('‚ùå Error al generar Excel', 'error');
                    }
                };

                if (loading) {
                    return (
                        <div className="h-full w-full flex items-center justify-center bg-gray-100 dark:bg-slate-900">
                            <div className="text-center">
                                {RefreshCw && <RefreshCw className="animate-spin mx-auto mb-4 text-emerald-600" size={40} />}
                                <p className="text-gray-600 dark:text-gray-400">Cargando reportes...</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="h-full w-full overflow-y-auto p-6 bg-gray-100 dark:bg-slate-900">
                        {/* HEADER */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                            <h2 className="text-3xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                                {BarChart3 && <BarChart3 size={32} />}
                                <span>Reporte Financiero</span>
                            </h2>

                            <div className="flex flex-wrap gap-2">
                                {/* Selector de rango */}
                                <div className="flex bg-white dark:bg-slate-800 rounded-lg p-1 shadow-sm border border-gray-200 dark:border-slate-700">
                                    {['today', 'week', 'month'].map(r => (
                                        <button
                                            key={r}
                                            onClick={() => setDateRange(r)}
                                            className={`px-4 py-2 rounded-md text-sm font-bold capitalize transition ${dateRange === r
                                                ? 'bg-emerald-600 text-white shadow'
                                                : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'
                                                }`}
                                        >
                                            {r === 'today' ? 'Hoy' : (r === 'week' ? '7 D√≠as' : 'Mes')}
                                        </button>
                                    ))}
                                </div>

                                {/* Bot√≥n exportar PDF */}
                                <button
                                    onClick={exportToPDF}
                                    className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-sm transition flex items-center gap-2"
                                >
                                    {Download && <Download size={18} />}
                                    <span>PDF</span>
                                </button>

                                {/* Bot√≥n exportar Excel */}
                                <button
                                    onClick={exportToExcel}
                                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-sm transition flex items-center gap-2"
                                >
                                    {Download && <Download size={18} />}
                                    <span>Excel</span>
                                </button>

                                {/* Bot√≥n gr√°ficos */}
                                <button
                                    onClick={() => setShowGraphs(!showGraphs)}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm transition flex items-center gap-2"
                                >
                                    {BarChart3 && <BarChart3 size={18} />}
                                    <span>{showGraphs ? 'Ocultar' : 'Ver'} Gr√°ficos</span>
                                </button>
                            </div>
                        </div>

                        {/* TARJETAS PRINCIPALES */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            {/* Ingresos Contado */}
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-l-8 border-green-500">
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Ingresos (Contado)
                                </p>
                                <h3 className="text-3xl font-bold text-green-600 mt-2">
                                    {formatMoney(totalSalesContado, config.currency)}
                                </h3>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    {salesContado.length} {salesContado.length === 1 ? 'venta' : 'ventas'}
                                </p>
                            </div>

                            {/* Ingresos Fiado */}
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-l-8 border-yellow-500">
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Ingresos (Fiado)
                                </p>
                                <h3 className="text-3xl font-bold text-yellow-600 mt-2">
                                    {formatMoney(totalSalesFiado, config.currency)}
                                </h3>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    {salesFiado.length} {salesFiado.length === 1 ? 'venta' : 'ventas'}
                                </p>
                            </div>

                            {/* Gastos */}
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border-l-8 border-red-500">
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Gastos Operativos
                                </p>
                                <h3 className="text-3xl font-bold text-red-600 mt-2">
                                    {formatMoney(totalExpenses, config.currency)}
                                </h3>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    {reportData.expenses.length} {reportData.expenses.length === 1 ? 'gasto' : 'gastos'}
                                </p>
                            </div>

                            {/* Utilidad Neta (Solo Contado) */}
                            <div className={`bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border-l-8 ${netProfitContado >= 0 ? 'border-blue-600' : 'border-orange-500'
                                }`}>
                                <p className="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase">
                                    Utilidad (Contado)
                                </p>
                                <h3 className={`text-3xl font-bold mt-2 ${netProfitContado >= 0 ? 'text-blue-600' : 'text-orange-500'
                                    }`}>
                                    {formatMoney(netProfitContado, config.currency)}
                                </h3>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    Sin incluir fiados
                                </p>
                            </div>
                        </div>

                        {/* UTILIDAD TOTAL (Destacada) */}
                        <div className={`bg-gradient-to-r ${netProfitTotal >= 0
                            ? 'from-blue-500 to-blue-600'
                            : 'from-orange-500 to-orange-600'
                            } p-8 rounded-2xl shadow-xl mb-8 text-white`}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-bold uppercase opacity-90">
                                        üí∞ Utilidad Neta Total (Incluye Todo)
                                    </p>
                                    <h2 className="text-5xl font-bold mt-2">
                                        {formatMoney(netProfitTotal, config.currency)}
                                    </h2>
                                    <p className="text-sm mt-2 opacity-90">
                                        {netProfitTotal >= 0 ? '‚úÖ Ganancia positiva' : '‚ö†Ô∏è En p√©rdida'} | Contado + Fiado - Gastos
                                    </p>
                                </div>
                                <div className="text-6xl opacity-20">
                                    {netProfitTotal >= 0 ? 'üìà' : 'üìâ'}
                                </div>
                            </div>
                        </div>

                        {/* DISTRIBUCI√ìN DE INGRESOS (Men√∫ vs Otros) */}
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg mb-8">
                            <h3 className="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center flex items-center justify-center gap-2">
                                <span>üçΩÔ∏è</span>
                                <span>Distribuci√≥n de Ingresos</span>
                            </h3>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                                {/* Ingresos Men√∫ */}
                                <div className="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 p-6 rounded-xl border-2 border-orange-300 dark:border-orange-700">
                                    <div className="text-center">
                                        <div className="text-4xl mb-3">üçΩÔ∏è</div>
                                        <p className="text-sm font-bold text-orange-700 dark:text-orange-400 uppercase mb-2">
                                            Sistema de Men√∫
                                        </p>
                                        <h3 className="text-4xl font-bold text-orange-600 dark:text-orange-400 mb-2">
                                            {formatMoney(totalSalesMenu, config.currency)}
                                        </h3>
                                        <p className="text-xs text-orange-600 dark:text-orange-400 mb-3">
                                            {salesMenu.length} {salesMenu.length === 1 ? 'orden' : '√≥rdenes'}
                                        </p>
                                        <div className="w-full bg-orange-200 dark:bg-orange-900 rounded-full h-2">
                                            <div
                                                className="bg-orange-600 h-2 rounded-full transition-all"
                                                style={{ width: `${totalSales > 0 ? (totalSalesMenu / totalSales * 100).toFixed(0) : 0}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-sm font-bold text-orange-700 dark:text-orange-400 mt-2">
                                            {totalSales > 0 ? (totalSalesMenu / totalSales * 100).toFixed(1) : 0}% del total
                                        </p>
                                    </div>
                                </div>

                                {/* Ingresos Otros (POS/Carta) */}
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-xl border-2 border-blue-300 dark:border-blue-700">
                                    <div className="text-center">
                                        <div className="text-4xl mb-3">üõí</div>
                                        <p className="text-sm font-bold text-blue-700 dark:text-blue-400 uppercase mb-2">
                                            POS & Carta
                                        </p>
                                        <h3 className="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-2">
                                            {formatMoney(totalSalesOtros, config.currency)}
                                        </h3>
                                        <p className="text-xs text-blue-600 dark:text-blue-400 mb-3">
                                            {salesOtros.length} {salesOtros.length === 1 ? 'venta' : 'ventas'}
                                        </p>
                                        <div className="w-full bg-blue-200 dark:bg-blue-900 rounded-full h-2">
                                            <div
                                                className="bg-blue-600 h-2 rounded-full transition-all"
                                                style={{ width: `${totalSales > 0 ? (totalSalesOtros / totalSales * 100).toFixed(0) : 0}%` }}
                                            ></div>
                                        </div>
                                        <p className="text-sm font-bold text-blue-700 dark:text-blue-400 mt-2">
                                            {totalSales > 0 ? (totalSalesOtros / totalSales * 100).toFixed(1) : 0}% del total
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Total combinado */}
                            <div className="mt-6 text-center p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
                                <p className="text-sm text-gray-600 dark:text-gray-400 mb-1">Total Ingresos Combinados</p>
                                <p className="text-2xl font-bold text-gray-800 dark:text-white">{formatMoney(totalSales, config.currency)}</p>
                            </div>
                        </div>

                        {/* GR√ÅFICOS */}
                        {showGraphs && (
                            <div className="mb-8 space-y-6">
                                <h3 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">
                                    üìä An√°lisis Visual
                                </h3>

                                <GraphsSection
                                    byMethod={byMethod}
                                    expByCategory={expByCategory}
                                    salesMenu={totalSalesMenu}
                                    salesOtros={totalSalesOtros}
                                    salesContado={totalSalesContado}
                                    salesFiado={totalSalesFiado}
                                    expenses={totalExpenses}
                                    netProfit={netProfitTotal}
                                    currency={config.currency}
                                />
                            </div>
                        )}

                        {/* DETALLES */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-8">
                            {/* Ingresos por M√©todo */}
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                                <h4 className="font-bold text-gray-700 dark:text-gray-200 mb-4 pb-2 border-b border-gray-200 dark:border-slate-700">
                                    üí≥ Ingresos por M√©todo de Pago
                                </h4>

                                {Object.keys(byMethod).length === 0 ? (
                                    <p className="text-gray-400 text-sm text-center py-4">
                                        Sin ventas en este periodo
                                    </p>
                                ) : (
                                    <div className="space-y-3">
                                        {Object.entries(byMethod)
                                            .sort((a, b) => b[1] - a[1])
                                            .map(([method, amount]) => {
                                                const percentage = totalSales > 0 ? (amount / totalSales * 100).toFixed(1) : 0;
                                                return (
                                                    <div key={method} className="space-y-1">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-gray-600 dark:text-gray-400 font-medium">
                                                                {method}
                                                            </span>
                                                            <span className="font-bold text-gray-900 dark:text-white">
                                                                {formatMoney(amount, config.currency)}
                                                            </span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2">
                                                            <div
                                                                className="bg-emerald-600 h-2 rounded-full transition-all"
                                                                style={{ width: `${percentage}%` }}
                                                            ></div>
                                                        </div>
                                                        <p className="text-xs text-gray-500 dark:text-gray-400">
                                                            {percentage}% del total
                                                        </p>
                                                    </div>
                                                );
                                            })
                                        }
                                    </div>
                                )}
                            </div>

                            {/* Gastos por Categor√≠a */}
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                                <h4 className="font-bold text-gray-700 dark:text-gray-200 mb-4 pb-2 border-b border-gray-200 dark:border-slate-700">
                                    üí∏ Gastos por Categor√≠a
                                </h4>

                                {Object.keys(expByCategory).length === 0 ? (
                                    <p className="text-gray-400 text-sm text-center py-4">
                                        Sin gastos en este periodo
                                    </p>
                                ) : (
                                    <div className="space-y-3">
                                        {Object.entries(expByCategory)
                                            .sort((a, b) => b[1] - a[1])
                                            .map(([category, amount]) => {
                                                const percentage = totalExpenses > 0 ? (amount / totalExpenses * 100).toFixed(1) : 0;
                                                return (
                                                    <div key={category} className="space-y-1">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-gray-600 dark:text-gray-400 font-medium">
                                                                {category}
                                                            </span>
                                                            <span className="font-bold text-red-600 dark:text-red-400">
                                                                -{formatMoney(amount, config.currency)}
                                                            </span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2">
                                                            <div
                                                                className="bg-red-600 h-2 rounded-full transition-all"
                                                                style={{ width: `${percentage}%` }}
                                                            ></div>
                                                        </div>
                                                        <p className="text-xs text-gray-500 dark:text-gray-400">
                                                            {percentage}% del total de gastos
                                                        </p>
                                                    </div>
                                                );
                                            })
                                        }
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // Componente de Gr√°ficos
            const GraphsSection = ({ byMethod, expByCategory, salesMenu, salesOtros, salesContado, salesFiado, expenses, netProfit, currency }) => {
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Gr√°fico de Pastel - Distribuci√≥n de Ingresos por Tipo */}
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                            <h5 className="font-bold text-gray-700 dark:text-gray-200 mb-4">
                                ü•ß Distribuci√≥n de Ingresos (Men√∫ vs POS)
                            </h5>
                            <div className="flex items-center justify-center" style={{ height: '300px' }}>
                                <PieChart data={[
                                    { label: 'Men√∫', value: salesMenu, color: '#f97316' },
                                    { label: 'POS/Carta', value: salesOtros, color: '#3b82f6' }
                                ]} currency={currency} />
                            </div>
                        </div>

                        {/* Gr√°fico de Pastel - Contado vs Fiado */}
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                            <h5 className="font-bold text-gray-700 dark:text-gray-200 mb-4">
                                üí∞ Contado vs Fiado
                            </h5>
                            <div className="flex items-center justify-center" style={{ height: '300px' }}>
                                <PieChart data={[
                                    { label: 'Contado', value: salesContado, color: '#10b981' },
                                    { label: 'Fiado', value: salesFiado, color: '#f59e0b' }
                                ]} currency={currency} />
                            </div>
                        </div>

                        {/* Gr√°fico de Barras - Comparaci√≥n General */}
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                            <h5 className="font-bold text-gray-700 dark:text-gray-200 mb-4">
                                üìä Comparaci√≥n General
                            </h5>
                            <BarChart data={[
                                { label: 'Ingresos Totales', value: salesContado + salesFiado, color: '#10b981' },
                                { label: 'Gastos', value: expenses, color: '#ef4444' },
                                { label: 'Utilidad Neta', value: netProfit >= 0 ? netProfit : 0, color: '#3b82f6' }
                            ]} currency={currency} />
                        </div>

                        {/* Gr√°fico de M√©todos de Pago */}
                        {Object.keys(byMethod).length > 0 && (
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                                <h5 className="font-bold text-gray-700 dark:text-gray-200 mb-4">
                                    üí≥ M√©todos de Pago
                                </h5>
                                <HorizontalBarChart
                                    data={Object.entries(byMethod).map(([label, value]) => ({
                                        label,
                                        value,
                                        color: '#10b981'
                                    }))}
                                    currency={currency}
                                />
                            </div>
                        )}

                        {/* Gr√°fico de Gastos por Categor√≠a */}
                        {Object.keys(expByCategory).length > 0 && (
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                                <h5 className="font-bold text-gray-700 dark:text-gray-200 mb-4">
                                    üí∏ Gastos por Categor√≠a
                                </h5>
                                <HorizontalBarChart
                                    data={Object.entries(expByCategory).map(([label, value]) => ({
                                        label,
                                        value,
                                        color: '#ef4444'
                                    }))}
                                    currency={currency}
                                />
                            </div>
                        )}
                    </div>
                );
            };

            // Componente de gr√°fico de pastel
            const PieChart = ({ data, currency }) => {
                const total = data.reduce((sum, item) => sum + item.value, 0);
                if (total === 0) return <p className="text-gray-400">No hay datos</p>;

                let currentAngle = -90;
                const paths = data.map(item => {
                    const percentage = (item.value / total) * 100;
                    const angle = (percentage / 100) * 360;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;
                    currentAngle = endAngle;

                    const startRad = (startAngle * Math.PI) / 180;
                    const endRad = (endAngle * Math.PI) / 180;
                    const x1 = 100 + 80 * Math.cos(startRad);
                    const y1 = 100 + 80 * Math.sin(startRad);
                    const x2 = 100 + 80 * Math.cos(endRad);
                    const y2 = 100 + 80 * Math.sin(endRad);
                    const largeArc = angle > 180 ? 1 : 0;

                    return {
                        d: `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArc} 1 ${x2} ${y2} Z`,
                        color: item.color,
                        label: item.label,
                        value: item.value,
                        percentage: percentage.toFixed(1)
                    };
                });

                return (
                    <div className="w-full">
                        <svg viewBox="0 0 200 200" className="w-full max-w-xs mx-auto">
                            {paths.map((path, i) => (
                                <path
                                    key={i}
                                    d={path.d}
                                    fill={path.color}
                                    stroke="white"
                                    strokeWidth="2"
                                />
                            ))}
                        </svg>
                        <div className="mt-4 space-y-2">
                            {paths.map((path, i) => (
                                <div key={i} className="flex items-center justify-between text-sm">
                                    <div className="flex items-center gap-2">
                                        <div
                                            className="w-4 h-4 rounded"
                                            style={{ backgroundColor: path.color }}
                                        ></div>
                                        <span className="text-gray-700 dark:text-gray-300">{path.label}</span>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-gray-900 dark:text-white">
                                            {formatMoney(path.value, currency)}
                                        </p>
                                        <p className="text-xs text-gray-500">{path.percentage}%</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // Componente de gr√°fico de barras vertical
            const BarChart = ({ data, currency }) => {
                const maxValue = Math.max(...data.map(d => d.value), 1);

                return (
                    <div className="space-y-4">
                        <div className="flex items-end justify-around gap-4" style={{ height: '250px' }}>
                            {data.map((item, i) => {
                                const height = (item.value / maxValue) * 100;
                                return (
                                    <div key={i} className="flex-1 flex flex-col items-center gap-2">
                                        <div className="text-sm font-bold text-gray-900 dark:text-white text-center">
                                            {formatMoney(item.value, currency)}
                                        </div>
                                        <div
                                            className="w-full rounded-t-lg transition-all hover:opacity-80"
                                            style={{
                                                height: `${height}%`,
                                                backgroundColor: item.color,
                                                minHeight: item.value > 0 ? '20px' : '0'
                                            }}
                                        ></div>
                                        <div className="text-xs text-gray-600 dark:text-gray-400 text-center font-medium">
                                            {item.label}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // Componente de gr√°fico de barras horizontal
            const HorizontalBarChart = ({ data, currency }) => {
                const maxValue = Math.max(...data.map(d => d.value), 1);

                return (
                    <div className="space-y-3">
                        {data.map((item, i) => {
                            const width = (item.value / maxValue) * 100;
                            return (
                                <div key={i} className="space-y-1">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-gray-700 dark:text-gray-300 font-medium">
                                            {item.label}
                                        </span>
                                        <span className="font-bold text-gray-900 dark:text-white">
                                            {formatMoney(item.value, currency)}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-6 overflow-hidden">
                                        <div
                                            className="h-full rounded-full transition-all flex items-center justify-end pr-2 text-white text-xs font-bold"
                                            style={{
                                                width: `${width}%`,
                                                backgroundColor: item.color,
                                                minWidth: item.value > 0 ? '30px' : '0'
                                            }}
                                        >
                                            {width > 20 && `${width.toFixed(0)}%`}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };
            const OrdersView = () => {
                const [tab, setTab] = useState('active');
                const [selectedOrder, setSelectedOrder] = useState(null);
                const filteredOrders = orders.filter(checkLocation);
                const activeOrders = filteredOrders.filter(o => o.status !== 'Completado' && o.status !== 'Cancelado');
                const historyOrders = filteredOrders.filter(o => o.status === 'Completado' || o.status === 'Cancelado').slice(0, 50);

                const updateStatus = async (order, status) => {
                    await saveData('orders', { ...order, status }, order.id);
                    setSelectedOrder(null);
                };

                const sendToKitchen = async (order) => {
                    console.log('üç≥ Enviando a cocina:', order.id, 'Estado actual:', order.sentToKitchen);
                    await saveData('orders', { ...order, sentToKitchen: true }, order.id);
                    showCustomAlert('‚úÖ Orden enviada a cocina', 'success');
                    setSelectedOrder({ ...order, sentToKitchen: true });
                    console.log('‚úÖ Orden actualizada en estado local');
                };

                const displayOrders = tab === 'active' ? activeOrders : historyOrders;

                return (
                    <div className="scroll-view">
                        <div className="p-4 md:p-6 pb-32">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-emerald-900 dark:text-white">Pedidos</h2>
                                <div className="flex bg-gray-200 dark:bg-slate-700 rounded-lg p-1">
                                    <button onClick={() => setTab('active')} className={`px-4 py-1 rounded-md text-sm font-bold transition ${tab === 'active' ? 'bg-white dark:bg-slate-800 shadow text-emerald-700 dark:text-emerald-400' : 'text-gray-600 dark:text-gray-400'}`}>Pendientes</button>
                                    <button onClick={() => setTab('history')} className={`px-4 py-1 rounded-md text-sm font-bold transition ${tab === 'history' ? 'bg-white dark:bg-slate-800 shadow text-emerald-700 dark:text-emerald-400' : 'text-gray-600 dark:text-gray-400'}`}>Historial</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {displayOrders.length === 0 && <p className="text-gray-400 col-span-3 text-center py-10">No hay pedidos.</p>}
                                {displayOrders.map(o => (
                                    <div key={o.id} onClick={() => setSelectedOrder(o)} className={`bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 cursor-pointer hover:shadow-md transition ${o.status === 'Completado' ? 'border-l-gray-400 opacity-80' : 'border-l-emerald-500'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                            <h4 className="font-bold dark:text-white">#{o.id.slice(-4)} {o.customerName}</h4>
                                            <div className="flex flex-col gap-1 items-end">
                                                <span className={`text-xs px-2 py-1 rounded-full ${o.status === 'Completado' ? 'bg-gray-100 text-gray-600' : 'bg-yellow-100 text-yellow-800'}`}>{o.status}</span>
                                                {o.sentToKitchen === true ? (
                                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-green-100 text-green-700 font-bold">
                                                        ‚úÖ En cocina
                                                    </span>
                                                ) : (
                                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 font-bold">
                                                        üîî Pendiente cocina
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-400 mb-2">{new Date(o.date).toLocaleString()}</p>
                                        <p className="text-sm text-gray-500 dark:text-gray-400 mb-2 line-clamp-2">{o.items.map(i => `${i.quantity} ${i.name}`).join(', ')}</p>
                                        <div className="flex justify-between items-center mt-4 pt-4 border-t dark:border-slate-700">
                                            <span className="font-bold dark:text-white">{formatMoney(o.total, config.currency)}</span>
                                            <span className="text-xs text-emerald-600 dark:text-emerald-400 font-bold">Ver Detalles &rarr;</span>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {selectedOrder && (
                                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4" onClick={() => setSelectedOrder(null)}>
                                    <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                        <button onClick={() => setSelectedOrder(null)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">{X && <X size={24} />}</button>

                                        <h3 className="text-2xl font-bold text-emerald-900 dark:text-white mb-1">Orden #{selectedOrder.id.slice(-4)}</h3>
                                        <p className="text-gray-500 dark:text-gray-400 text-sm mb-4">{new Date(selectedOrder.date).toLocaleString()} - {selectedOrder.customerName}</p>

                                        {/* Badge de estado de cocina */}
                                        {selectedOrder.sentToKitchen === true ? (
                                            <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-900 p-3 rounded-lg mb-4 flex items-center gap-2">
                                                <span className="text-green-600 dark:text-green-400 text-2xl">‚úÖ</span>
                                                <div>
                                                    <p className="text-sm font-bold text-green-800 dark:text-green-300">Orden enviada a cocina</p>
                                                    <p className="text-xs text-green-600 dark:text-green-400">La cocina puede ver esta orden</p>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-900 p-3 rounded-lg mb-4 flex items-center gap-2">
                                                <span className="text-orange-600 dark:text-orange-400 text-2xl">üîî</span>
                                                <div>
                                                    <p className="text-sm font-bold text-orange-800 dark:text-orange-300">Orden NO enviada a cocina</p>
                                                    <p className="text-xs text-orange-600 dark:text-orange-400">Usa el bot√≥n abajo para enviarla</p>
                                                </div>
                                            </div>
                                        )}

                                        <div className="bg-gray-50 dark:bg-slate-700 p-4 rounded-xl mb-6 max-h-60 overflow-y-auto">
                                            {selectedOrder.items.map((item, idx) => (
                                                <div key={idx} className="flex justify-between items-center py-2 border-b last:border-0 border-gray-200 dark:border-slate-600">
                                                    <div className="flex gap-3">
                                                        <span className="font-bold text-emerald-700 dark:text-emerald-400 w-6">{item.quantity}x</span>
                                                        <span className="text-gray-800 dark:text-gray-200">{item.name}</span>
                                                    </div>
                                                    <span className="text-gray-600 dark:text-gray-400 font-medium">{formatMoney(item.price * item.quantity, config.currency)}</span>
                                                </div>
                                            ))}
                                            <div className="flex justify-between items-center mt-4 pt-2 border-t border-gray-300 dark:border-slate-600">
                                                <span className="font-bold text-lg dark:text-white">Total</span>
                                                <span className="font-bold text-xl text-emerald-700 dark:text-emerald-400">{formatMoney(selectedOrder.total, config.currency)}</span>
                                            </div>
                                        </div>

                                        <div className="space-y-4">
                                            {/* Bot√≥n Enviar a Cocina */}
                                            {selectedOrder.sentToKitchen !== true && (
                                                <div className="bg-orange-50 dark:bg-orange-900/20 p-4 rounded-xl border border-orange-200 dark:border-orange-900">
                                                    <button
                                                        onClick={() => sendToKitchen(selectedOrder)}
                                                        className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2"
                                                    >
                                                        <span className="text-xl">üç≥</span>
                                                        <span>Enviar a Cocina</span>
                                                    </button>
                                                </div>
                                            )}

                                            <div>
                                                <p className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Cambiar Estado</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {['Pendiente', 'En Proceso', 'Entregado', 'Completado'].map(status => (
                                                        <button
                                                            key={status}
                                                            onClick={() => updateStatus(selectedOrder, status)}
                                                            className={`px-4 py-2 rounded-lg text-sm font-bold border transition ${selectedOrder.status === status ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white dark:bg-slate-700 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-600'}`}
                                                        >
                                                            {status}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {user.role === ROLES.ADMIN && (
                                                <div className="pt-4 border-t dark:border-slate-700">
                                                    <button
                                                        onClick={() => {
                                                            if (confirm('¬øEliminar este pedido permanentemente?')) {
                                                                deleteData('orders', selectedOrder.id);
                                                                setSelectedOrder(null);
                                                            }
                                                        }}
                                                        className="w-full flex items-center justify-center gap-2 text-red-600 dark:text-red-400 font-bold hover:bg-red-50 dark:hover:bg-red-900/20 p-3 rounded-xl transition"
                                                    >
                                                        {Trash2 && <Trash2 size={18} />} Eliminar Pedido
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const UsersView = () => {
                const [team, setTeam] = useState([]);
                const [isEditing, setIsEditing] = useState(false);
                const [isSaving, setIsSaving] = useState(false);
                const [form, setForm] = useState({ name: '', pin: '', role: 'vendedor', permissions: [], image: null, locationId: 'all' });
                useEffect(() => { const { onSnapshot, collection } = window.firebaseModules; const unsub = onSnapshot(collection(db.current, 'artifacts', appId, 'public', 'data', 'team'), (snap) => setTeam(snap.docs.map(d => ({ id: d.id, ...d.data() })))); return () => unsub(); }, []);
                const handleSubmit = async (e) => { e.preventDefault(); if (isSaving) return; setIsSaving(true); try { if (!form.name || !form.pin) { alert("Completa todos los campos"); setIsSaving(false); return; } const isPinTaken = team.some(m => m.pin === form.pin && m.id !== form.id); if (isPinTaken) { alert("‚ö†Ô∏è ERROR: Ese PIN ya est√° en uso. Elige otro."); setIsSaving(false); return; } const { id, ...dataToSave } = form; await saveData('team', dataToSave, form.id); alert("¬°Guardado correctamente!"); setIsEditing(false); setForm({ name: '', pin: '', role: 'vendedor', permissions: [], image: null, locationId: 'all' }); } catch (error) { console.error(error); alert("Error al guardar: " + error.message); } finally { setIsSaving(false); } };
                const handleImage = async (e) => { if (e.target.files[0]) setForm({ ...form, image: await compressImage(e.target.files[0], 200) }); };
                const togglePermission = (permId) => setForm(prev => ({ ...prev, permissions: prev.permissions.includes(permId) ? prev.permissions.filter(p => p !== permId) : [...prev.permissions, permId] }));
                const generatePin = () => { let newPin; do { newPin = Math.floor(100000 + Math.random() * 900000).toString(); } while (team.some(m => m.pin === newPin)); setForm(prev => ({ ...prev, pin: newPin })); };

                return (<div className="scroll-view"><div className="p-4 md:p-6 pb-32 space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-emerald-900">Equipo</h2><button onClick={() => { setIsEditing(true); setForm({ name: '', pin: '', role: 'vendedor', permissions: [], image: null, locationId: 'all' }); }} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2">{Plus && <Plus size={18} />} Nuevo Integrante</button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{team.map(m => (<div key={m.id} className="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-4"><div className="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-emerald-100">{m.image ? <img src={m.image} className="w-full h-full object-cover" /> : <span className="text-xl font-bold text-gray-400">{m.name[0]}</span>}</div><div className="flex-1"><h4 className="font-bold text-gray-800">{m.name}</h4><p className="text-xs text-gray-500 uppercase">{m.role}</p>{m.locationId && m.locationId !== 'all' ? <span className="text-xs text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded-full flex items-center gap-1 w-fit mt-1">üìç {config.locations.find(l => l.id === m.locationId)?.name || 'Sede Desc.'}</span> : <span className="text-xs text-gray-400 font-bold bg-gray-100 px-2 py-0.5 rounded-full w-fit mt-1">üåé Global</span>}</div><button onClick={() => { setForm(m); setIsEditing(true); }} className="p-2 text-emerald-600 hover:bg-emerald-50 rounded">{Settings && <Settings size={18} />}</button><button onClick={() => deleteData('team', m.id)} className="p-2 text-red-600 hover:bg-red-50 rounded">{Trash2 && <Trash2 size={18} />}</button></div>))}</div>{isEditing && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white rounded-xl w-full max-w-lg p-6 max-h-[85vh] overflow-y-auto"><h3 className="text-xl font-bold mb-4">{form.id ? 'Editar' : 'Nuevo'} Integrante</h3><form onSubmit={handleSubmit} className="space-y-4"><div className="flex justify-center mb-4"><label className="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-emerald-500 overflow-hidden relative group">{form.image ? <img src={form.image} className="w-full h-full object-cover" /> : (Camera && <Camera className="text-gray-400" />)}<input type="file" className="hidden" onChange={handleImage} accept="image/*" /></label></div><input required placeholder="Nombre de Usuario" className="w-full p-2 border rounded" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} /><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-600">PIN Acceso</label><div className="flex gap-2"><input required placeholder="######" maxLength="6" className="w-full p-2 border rounded font-mono text-center tracking-widest" value={form.pin} onChange={e => setForm({ ...form, pin: e.target.value })} /><button type="button" onClick={generatePin} className="px-2 bg-gray-200 rounded hover:bg-gray-300">{RefreshCw && <RefreshCw size={14} />}</button></div></div><div><label className="text-xs font-bold text-gray-600">Rol</label><select className="w-full p-2 border rounded" value={form.role} onChange={e => setForm({ ...form, role: e.target.value })}>{Object.values(ROLES).map(r => <option key={r} value={r}>{r.charAt(0).toUpperCase() + r.slice(1)}</option>)}</select></div></div><div><label className="text-xs font-bold text-gray-600 mb-1 block">Sede Asignada</label><select className="w-full p-2 border rounded bg-white text-sm" value={form.locationId || 'all'} onChange={e => setForm({ ...form, locationId: e.target.value })}><option value="all">üåé Todas (Global / Admin)</option>{config.locations.map(l => <option key={l.id} value={l.id}>üìç {l.name}</option>)}</select></div><div className="border-t pt-4"><label className="text-sm font-bold text-emerald-800 mb-2 block">Permisos de Acceso</label><div className="grid grid-cols-2 gap-2">{PERMISSIONS_LIST.map(perm => (<label key={perm.id} className={`flex items-center gap-2 p-2 rounded border cursor-pointer ${form.permissions.includes(perm.id) ? 'bg-emerald-50 border-emerald-500' : 'bg-gray-50 border-gray-200'}`}><input type="checkbox" className="accent-emerald-600" checked={form.permissions.includes(perm.id)} onChange={() => togglePermission(perm.id)} /><span className="text-sm">{perm.label}</span></label>))}</div></div><div className="flex justify-end gap-2 mt-6"><button type="button" onClick={() => setIsEditing(false)} className="px-4 py-2 text-gray-600">Cancelar</button><button type="submit" disabled={isSaving} className="px-6 py-2 bg-emerald-600 text-white rounded font-bold flex items-center gap-2 disabled:opacity-50">{isSaving ? <><RefreshCw className="animate-spin" size={18} /> Guardando...</> : 'Guardar'}</button></div></form></div></div>)}</div></div>);
            };

            const AccountView = () => (
                <div className="scroll-view"><div className="p-4 md:p-6 pb-32"><div className="max-w-md mx-auto bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden mt-4 md:mt-10 border dark:border-slate-700"><div className="bg-emerald-600 dark:bg-emerald-800 p-6 text-center"><div className="w-24 h-24 bg-white dark:bg-slate-700 rounded-full mx-auto flex items-center justify-center text-4xl text-emerald-600 dark:text-emerald-400 font-bold border-4 border-emerald-200 dark:border-emerald-700 overflow-hidden mb-4 shadow-inner">{user?.image ? <img src={user.image} className="w-full h-full object-cover" /> : user?.name?.[0]}</div><h2 className="text-2xl font-bold text-white">{user?.name}</h2><p className="text-emerald-100 opacity-90">{user?.role}</p></div><div className="p-6 space-y-4"><div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600"><span className="text-gray-500 dark:text-gray-400 flex items-center gap-2">{KeyRound && <KeyRound size={16} />} PIN de Acceso</span><span className="font-mono font-bold text-gray-800 dark:text-white">****</span></div><div className="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600"><span className="text-gray-500 dark:text-gray-400 flex items-center gap-2">{Shield && <Shield size={16} />} Permisos</span><span className="font-bold text-emerald-600 dark:text-emerald-400">{user?.permissions?.length || 0} m√≥dulos</span></div><button onClick={handleLogout} className="w-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 py-3 rounded-lg font-bold hover:bg-red-100 dark:hover:bg-red-900/40 transition flex items-center justify-center gap-2 border border-red-200 dark:border-red-900">{LogOut && <LogOut size={20} />} Cerrar Sesi√≥n</button></div></div></div></div>
            );

            const CustomAlert = ({ alert, onClose }) => {
                const [isVisible, setIsVisible] = useState(false);
                useEffect(() => {
                    setTimeout(() => setIsVisible(true), 10);
                    const timeout = setTimeout(() => {
                        setIsVisible(false);
                        setTimeout(onClose, 300);
                    }, alert.duration - 300);
                    return () => clearTimeout(timeout);
                }, []);
                const styles = {
                    success: { bg: 'bg-gradient-to-r from-green-500 to-emerald-600', icon: '‚úÖ', border: 'border-green-600' },
                    error: { bg: 'bg-gradient-to-r from-red-500 to-red-600', icon: '‚ùå', border: 'border-red-600' },
                    warning: { bg: 'bg-gradient-to-r from-yellow-500 to-orange-500', icon: '‚ö†Ô∏è', border: 'border-yellow-600' },
                    info: { bg: 'bg-gradient-to-r from-blue-500 to-blue-600', icon: '‚ÑπÔ∏è', border: 'border-blue-600' }
                };
                const style = styles[alert.type] || styles.info;
                return (
                    <div className={`${style.bg} text-white px-6 py-4 rounded-xl shadow-2xl border-l-4 ${style.border} pointer-events-auto transform transition-all duration-300 min-w-[320px] max-w-md ${isVisible ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}`}>
                        <div className="flex items-center gap-3">
                            <span className="text-3xl">{style.icon}</span>
                            <div className="flex-1"><p className="font-bold text-lg">{alert.message}</p></div>
                            <button onClick={() => { setIsVisible(false); setTimeout(onClose, 300); }} className="text-white hover:text-gray-200 transition">{X && <X size={20} />}</button>
                        </div>
                    </div>
                );
            };

            const NavBtn = ({ icon: Icon, label, view }) => (
                <button onClick={() => { setCurrentView(view); setIsMenuOpen(false); }} className={`flex items-center gap-3 w-full p-3 rounded-lg transition-colors ${currentView === view ? 'bg-emerald-700 text-white shadow-lg' : 'hover:bg-emerald-800 text-emerald-100'}`}>
                    {Icon && <Icon size={20} />} <span className="font-medium">{label}</span>
                </button>
            );

            const Sidebar = () => (
                <>
                    {isMenuOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setIsMenuOpen(false)}></div>}
                    <aside className={`fixed top-0 left-0 h-full w-64 bg-emerald-900 text-white z-50 transition-transform duration-300 flex flex-col shadow-2xl ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0`}>
                        <div className="p-6 border-b border-emerald-800 flex justify-between items-center shrink-0"><h2 className="text-xl font-bold text-emerald-100">STOCKEA</h2><button onClick={() => setIsMenuOpen(false)} className="md:hidden text-emerald-300 hover:text-white">{X && <X size={24} />}</button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2 pb-24 scroll-view">
                            <NavBtn icon={Home} label="Principal" view="home" />
                            {hasAccess('pos') && <NavBtn icon={LayoutDashboard} label="Punto de Venta" view="pos" />}
                            {hasAccess('orders') && <NavBtn icon={ClipboardList} label="Pedidos" view="orders" />}
                            {hasAccess('customers') && <NavBtn icon={Users} label={config.appMode === 'kiosk' ? 'Comunidad' : 'Clientes'} view="customers" />}
                            {hasAccess('verification') && <NavBtn icon={CheckSquare} label="Verif. Digital" view="verification" />}
                            {hasAccess('inventory') && <NavBtn icon={Package} label="Inventario" view="inventory" />}
                            {hasAccess('waiter') && <NavBtn icon={Utensils} label="Sistema de Menu" view="waiter" />}
                            {hasAccess('qrs') && <NavBtn icon={QrCode} label="QRs" view="qrs" />}
                            {hasAccess('reports') && <NavBtn icon={DollarSign} label="Reportes" view="reports" />}
                            {hasAccess('alerts') && <NavBtn icon={AlertTriangle} label="Alertas" view="alerts" />}
                            {hasAccess('users') && <NavBtn icon={UserCheck} label="Equipo" view="users" />}
                            {hasAccess('kitchen') && <NavBtn icon={Utensils} label="Cocina" view="kitchen" />}
                            {hasAccess('settings') && <NavBtn icon={Settings} label="Configuraci√≥n" view="settings" />}
                            {hasAccess('chat') && <NavBtn icon={MessageSquare} label="Chat de Equipo" view="chat" />}
                            {hasAccess('expenses') && <NavBtn icon={TrendingDown} label="Gastos" view="expenses" />}
                        </div>
                        <div onClick={() => { setCurrentView('account'); setIsMenuOpen(false); }} className="p-4 border-t border-emerald-800 bg-emerald-950 cursor-pointer hover:bg-emerald-900 transition shrink-0"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center font-bold text-white overflow-hidden border-2 border-emerald-500 shrink-0">{user?.image ? <img src={user.image} className="w-full h-full object-cover" /> : user?.name?.[0]}</div><div className="overflow-hidden min-w-0"><p className="font-bold text-sm truncate text-white">{user?.name}</p><p className="text-xs text-emerald-400 capitalize truncate">{user?.role}</p></div></div></div>
                    </aside>
                </>
            );

            // Render l√≥gico del App
            if (loading) return <div className="h-screen flex items-center justify-center text-emerald-600">{RefreshCw && <RefreshCw className="animate-spin" size={40} />}</div>;

            if (!user) return (
                <>
                    <ContactoModal mostrar={mostrarContacto} cerrar={() => setMostrarContacto(false)} />
                    <div className="min-h-screen flex items-center justify-center bg-emerald-900 p-4 scroll-view">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                            <div className="w-32 h-32 mx-auto mb-4 flex items-center justify-center">
                                <img src="logo.png" alt="Logo" className="w-full h-full object-contain drop-shadow-md" />
                            </div>
                            <h1 className="text-3xl font-bold text-emerald-800 mb-2">STOCKEA</h1>
                            <p className="text-gray-500 mb-6">Inicia sesi√≥n con tus credenciales</p>
                            <div className="space-y-4">
                                <div className="text-left"><label className="text-xs font-bold text-gray-500 ml-1">Usuario o Email</label><input type="text" placeholder="Admin o tu@email.com" className="w-full p-3 border rounded-xl outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" value={loginUser} onChange={e => setLoginUser(e.target.value)} /></div>
                                <div className="text-left"><label className="text-xs font-bold text-gray-500 ml-1">PIN / Contrase√±a</label><input type="password" placeholder="******" className="w-full p-3 border rounded-xl outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 font-mono" value={loginPin} onChange={e => { setLoginPin(e.target.value); setLoginError(''); }} /></div>
                                {loginError && <p className="text-red-500 text-sm font-bold animate-pulse">{loginError}</p>}
                                <button onClick={handleLogin} className="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 transition shadow-lg">Ingresar</button>
                                <div className="relative my-3"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200"></div></div><div className="relative flex justify-center text-xs"><span className="px-2 bg-white text-gray-400">o</span></div></div>
                                <button onClick={() => setMostrarContacto(true)} className="w-full bg-white border-2 border-emerald-600 text-emerald-600 py-3 rounded-lg font-bold hover:bg-emerald-50 transition">üì® Solicitar Stockea para mi Negocio</button>
                                <div className="text-xs text-gray-400 mt-4">stockea.soporte@gmail.com</div>
                                <div className="text-xs text-gray-300 mt-6">¬© 2024 Stockea. Todos los derechos reservados.</div>
                            </div>
                        </div>
                    </div>
                </>
            );

            return (
                <div className={`h-full w-full bg-gray-50 dark:bg-slate-900 flex flex-col overflow-hidden ${config.darkMode ? 'dark' : ''}`}>
                    <header className="bg-white dark:bg-slate-800 h-14 shadow-sm flex items-center px-4 justify-between sticky top-0 z-30 shrink-0">
                        <div className="flex items-center gap-3"><button onClick={() => setIsMenuOpen(true)} className="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-700 dark:text-white">{Menu && <Menu size={24} />}</button><h1 className="font-bold text-lg text-emerald-800 dark:text-emerald-100 hidden md:block">{config.storeName}</h1></div>
                        <div className="flex items-center gap-2"><div className="relative"><select className="appearance-none bg-emerald-50 dark:bg-slate-700 text-emerald-800 dark:text-white pl-8 pr-8 py-1.5 rounded-full text-xs font-bold border border-emerald-200 dark:border-slate-600 outline-none focus:ring-2 focus:ring-emerald-500 transition-all cursor-pointer" value={currentLocation} onChange={(e) => setCurrentLocation(e.target.value)}><option value="all">üåé Global (Ver Todo)</option>{config.locations.map(loc => (<option key={loc.id} value={loc.id}>üìç {loc.name}</option>))}</select><Globe size={14} className="absolute left-2.5 top-2 text-emerald-600 dark:text-emerald-400 pointer-events-none" /><ChevronDown size={14} className="absolute right-2.5 top-2 text-emerald-600 dark:text-emerald-400 pointer-events-none" /></div><span className="text-xs px-3 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-800 dark:text-emerald-100 rounded-full font-bold uppercase hidden sm:inline-block">{user.role}</span></div>
                    </header>
                    <main className="flex-1 flex overflow-hidden relative">
                        <Sidebar />
                        <div className="flex-1 h-full w-full relative">
                            {currentView === 'home' && <HomeView />}
                            {currentView === 'pos' && <POSView />}
                            {currentView === 'customers' && <CustomersView />}
                            {currentView === 'verification' && <DigitalVerificationView />}
                            {currentView === 'inventory' && <InventoryView orders={orders} />}
                            {currentView === 'settings' && <ConfigView />}
                            {currentView === 'orders' && <OrdersView />}
                            {currentView === 'reports' && <ReportsView />}
                            {currentView === 'alerts' && <AlertsView />}
                            {currentView === 'users' && <UsersView />}
                            {currentView === 'account' && <AccountView />}
                            {currentView === 'qrs' && <QRsView />}
                            {currentView === 'waiter' && <MenuView />}
                            {currentView === 'chat' && <ChatView />}
                            {currentView === 'expenses' && <ExpenseView />}
                            {currentView === 'kitchen' && <KitchenView />}
                        </div>
                    </main>

                    {/* Contenedor de Alertas Personalizadas */}
                    <div className="fixed top-4 right-4 z-[9999] space-y-2 pointer-events-none">
                        {customAlerts.map(alert => (
                            <CustomAlert key={alert.id} alert={alert} onClose={() => setCustomAlerts(prev => prev.filter(a => a.id !== alert.id))} />
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>